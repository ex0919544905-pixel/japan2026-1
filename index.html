<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#3F5B3B" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="2026æ—¥æœ¬åŒ—é™¸æ—…è¡Œ" />
    <title>2026æ—¥æœ¬åŒ—é™¸æ—…è¡Œ</title>

    <!-- Tailwind (CDN for prototype) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            boxShadow: {
              soft: "0 10px 25px rgba(0,0,0,.08)",
              soft2: "0 6px 18px rgba(0,0,0,.10)",
            },
            borderRadius: {
              xl2: "1.25rem",
            },
            colors: {
              sand: {
                50: "#FAF7F0",
                100: "#F3ECDD",
                200: "#E9DEC4",
                300: "#DCC9A2",
                400: "#CDB07F",
                500: "#B28E58",
                600: "#8F6F3F",
                700: "#6E5631",
                800: "#4B3B22",
                900: "#2A2115",
              },
              moss: {
                50: "#F3F7F2",
                100: "#E2EBDD",
                200: "#C1D3B8",
                300: "#9BB58C",
                400: "#76966A",
                500: "#5C7F52",
                600: "#46623F",
                700: "#364B30",
                800: "#263421",
                900: "#162012",
              },
              clay: {
                50: "#FBF6F2",
                100: "#F4E7DF",
                200: "#EBCFBE",
                300: "#DBB19B",
                400: "#C98E72",
                500: "#B56E4E",
                600: "#8E563C",
                700: "#6D4230",
                800: "#4C2E22",
                900: "#2C1B14",
              },
            },
          },
        },
      };
    </script>

    <!-- React (CDN) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      .safe-b {
        padding-bottom: max(16px, env(safe-area-inset-bottom));
      }
      .safe-t {
        padding-top: max(16px, env(safe-area-inset-top));
      }
      .grain::before {
        content: "";
        position: absolute;
        inset: 0;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="https://www.w3.org/2000/svg" width="120" height="120"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency=".8" numOctaves="2" stitchTiles="stitch"/></filter><rect width="120" height="120" filter="url(%23n)" opacity=".06"/></svg>');
        pointer-events: none;
        mix-blend-mode: multiply;
      }
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
    </style>
  </head>

  <body class="bg-sand-50 text-sand-900">
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useMemo, useRef, useState } = React;

      // ---------- Hero Image ----------
      // âœ… æŠŠç«‹å±±é€£å³°ç…§ç‰‡æ”¾åœ¨ index.html åŒè³‡æ–™å¤¾ï¼Œå–å tateyama.jpg
      // æˆ–æ”¹æˆç·šä¸Šåœ–ç‰‡ URL
      const HERO_IMAGE = "https://www.info-toyama.com/storage/special_features/339/responsive_images/U0rmlSsFfDZfqLX5S080ZdXPtjr7kmOIBCMTiwu7__1169_779.jpeg";

      // ---------- Helpers ----------
      const cx = (...args) => args.filter(Boolean).join(" ");
      const fmtInt = (n) => new Intl.NumberFormat("zh-TW").format(Math.round(n || 0));

      function loadJSON(key, fallback) {
        try {
          const raw = localStorage.getItem(key);
          if (!raw) return fallback;
          return JSON.parse(raw);
        } catch {
          return fallback;
        }
      }
      function saveJSON(key, value) {
        try {
          localStorage.setItem(key, JSON.stringify(value));
        } catch {}
      }

      // ---------- Trip Days ----------
      const TRIP_DAYS = [
        { key: "2026-01-01", label: "1/1ï¼ˆå››ï¼‰" },
        { key: "2026-01-02", label: "1/2ï¼ˆäº”ï¼‰" },
        { key: "2026-01-03", label: "1/3ï¼ˆå…­ï¼‰" },
        { key: "2026-01-04", label: "1/4ï¼ˆæ—¥ï¼‰" },
        { key: "2026-01-05", label: "1/5ï¼ˆä¸€ï¼‰" },
      ];

      // ---------- Locations for Weather (per day) ----------
      const LOC_BY_DAY = {
        "2026-01-01": { name: "é‡‘æ¾¤", lat: 36.5613, lon: 136.6562 },
        "2026-01-02": { name: "é«˜å±±", lat: 36.1333, lon: 137.25 },
        "2026-01-03": { name: "å¯Œå±±", lat: 36.696, lon: 137.214 },
        "2026-01-04": { name: "é‡‘æ¾¤", lat: 36.5613, lon: 136.6562 },
        "2026-01-05": { name: "å°æ¾", lat: 36.3946, lon: 136.4066 },
      };

      // ---------- Category visual system ----------
      const CATEGORY = {
        sight: { label: "æ™¯é»", pill: "bg-moss-100 text-moss-800 ring-1 ring-moss-200", dot: "bg-moss-500" },
        food: { label: "ç¾é£Ÿ", pill: "bg-clay-100 text-clay-800 ring-1 ring-clay-200", dot: "bg-clay-500" },
        move: { label: "äº¤é€š", pill: "bg-sand-100 text-sand-800 ring-1 ring-sand-200", dot: "bg-sand-500" },
        stay: { label: "ä½å®¿", pill: "bg-slate-100 text-slate-700 ring-1 ring-slate-200", dot: "bg-slate-500" },
      };

      // ---------- Schedule Data ----------
      const INITIAL_SCHEDULE = {
        "2026-01-01": [
          {
            id: "d1-1",
            time: "04:30",
            title: "å‡Œæ™¨åˆ°æ©Ÿå ´å ±åˆ°ï¼ˆé ä¼° 4â€“5 é»ï¼‰",
            category: "move",
            place: "æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ T2",
            note: "ææ—©åˆ°ã€æ›æ—¥å¹£/äº¤é€šç¥¨åˆ¸å¯ä¸€èµ·è™•ç†ã€‚",
            map: "https://www.google.com/maps/search/?api=1&query=æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ç¬¬äºŒèˆªå»ˆ",
          },
          {
            id: "d1-2",
            time: "06:35â€“10:25",
            title: "âœˆï¸ é•·æ¦® BR158 æ¡ƒåœ’äºŒèˆª â†’ å°æ¾æ©Ÿå ´",
            category: "move",
            place: "TPE â†’ KMQ",
            note: "æ©Ÿä¸Šä¼‘æ¯è£œçœ ã€‚è½åœ°å¾Œæ‰¾å·´å£«å”®ç¥¨æ©Ÿã€‚",
            map: "https://www.google.com/maps/search/?api=1&query=Komatsu%20Airport",
          },
          {
            id: "d1-3",
            time: "10:40",
            title: "æ­åˆ©æœ¨æ´¥å·´å£« â†’ é‡‘æ¾¤ç«™è¥¿å£ï¼ˆç´„ 40 åˆ†ï¼‰",
            category: "move",
            place: "å°æ¾æ©Ÿå ´ â†’ é‡‘æ¾¤ç«™ï¼ˆè¥¿å£ï¼‰",
            note: "å…ˆæ‰¾è‡ªå‹•è²©è³£æ©Ÿå–è»Šç¥¨ã€‚",
            map: "https://www.google.com/maps/search/?api=1&query=é‡‘æ¾¤ç«™è¥¿å£",
          },
          {
            id: "d1-4",
            time: "12:00",
            title: "æ­¥è¡Œ 5 åˆ†é˜ â†’ é‡‘æ¾¤ FORUS å¯„è¡Œæ & é€›è¡—",
            category: "sight",
            place: "Kanazawa FORUS / é‡‘æ¾¤è»Šç«™",
            note: "ä¸­åˆï½ä¸‹åˆä»¥è»Šç«™å‘¨é‚Šç‚ºä¸»ï¼Œè£œç‰©è³‡ã€‚",
            map: "https://www.google.com/maps/search/?api=1&query=Kanazawa%20Forus",
          },
          {
            id: "d1-5",
            time: "18:30",
            title: "ç‰‡ç”ºå‘¨é‚Šï¼šé—œæ±ç…® + æ™ƒæ™ƒ",
            category: "food",
            place: "ç‰‡ç”º Katamachi",
            note: "æ™šé¤å¾Œæ•£æ­¥æ¶ˆåŒ–ï¼Œæ—©é»ä¼‘æ¯ã€‚",
            map: "https://www.google.com/maps/search/?api=1&query=ç‰‡ç”º%20é‡‘æ¾¤",
          },
        ],
        "2026-01-02": [
          { id: "d2-1", time: "06:00", title: "èµ·åºŠæ¢³æ´—ã€ä¾¿åˆ©å•†åº—è£œçµ¦", category: "food", place: "é‡‘æ¾¤", note: "å‡ºç™¼å‰è²·æ°´/æ—©é¤ã€‚", map: "https://www.google.com/maps/search/?api=1&query=é‡‘æ¾¤%20ä¾¿åˆ©å•†åº—" },
          { id: "d2-2", time: "06:51â€“07:14", title: "ğŸš„ æ–°å¹¹ç·š åŠ Tsurugi 60ï¼šé‡‘æ¾¤ â†’ å¯Œå±±", category: "move", place: "é‡‘æ¾¤ç«™ â†’ å¯Œå±±ç«™", note: "æº–æ™‚é€²ç«™ï¼Œç•™æ„æœˆå°ã€‚", map: "https://www.google.com/maps/search/?api=1&query=Toyama%20Station" },
          { id: "d2-3", time: "07:58â€“09:28", title: "ğŸš„ ç‰¹æ€¥ é£›é©’ Hida 6ï¼ˆæŒ‡å®šå¸­ï¼‰ï¼šå¯Œå±± â†’ é«˜å±±", category: "move", place: "å¯Œå±±ç«™ â†’ é«˜å±±ç«™", note: "è»Šä¸Šå¯è£œçœ /çœ‹è¡Œç¨‹ã€‚", map: "https://www.google.com/maps/search/?api=1&query=Takayama%20Station" },
          { id: "d2-4", time: "10:00", title: "Starbucks é«˜å±±å²¡æœ¬åº—", category: "food", place: "é«˜å±±", note: "æ‹ç…§é»ï¼Œæš–èº«ã€‚", map: "https://www.google.com/maps/search/?api=1&query=ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹%20é«˜å±±å²¡æœ¬åº—" },
          { id: "d2-5", time: "10:40", title: "èˆ©å‚é…’é€ åº—", category: "sight", place: "é«˜å±±", note: "å°é…Œè©¦é£²æ³¨æ„æ­¥ä¼ã€‚", map: "https://www.google.com/maps/search/?api=1&query=èˆ©å‚é…’é€ åº—" },
          { id: "d2-6", time: "11:10", title: "miffy ãŠã‚„ã¤å ‚ï¼ˆé£›é©’é«˜å±±åº—ï¼‰", category: "food", place: "é«˜å±±", note: "ç”œé»è£œèƒ½é‡ã€‚", map: "https://www.google.com/maps/search/?api=1&query=miffy%20ãŠã‚„ã¤å ‚%20é£›é¨¨é«˜å±±åº—" },
          { id: "d2-7", time: "11:40", title: "é«˜å±±å¸ƒä¸äº­ / Pen Shop IMAI / æ©‹æœ¬ç…é¤…å ‚", category: "sight", place: "é«˜å±±è€è¡—", note: "æ²¿è·¯é€›ï¼Œå½ˆæ€§åƒåˆé¤ã€‚", map: "https://www.google.com/maps/search/?api=1&query=é«˜å±±%20å¤ã„ç”ºä¸¦" },
          { id: "d2-8", time: "15:17â€“16:44", title: "ğŸš„ ç‰¹æ€¥ é£›é©’ Hida 11ï¼šé«˜å±± â†’ å¯Œå±±", category: "move", place: "é«˜å±±ç«™ â†’ å¯Œå±±ç«™", note: "å›ç¨‹è£œçœ ã€‚", map: "https://www.google.com/maps/search/?api=1&query=Toyama%20Station" },
          { id: "d2-9", time: "17:10", title: "ğŸš„ æ–°å¹¹ç·šï¼ˆè‡ªç”±å¸­ï¼‰ï¼šå¯Œå±± â†’ é‡‘æ¾¤", category: "move", place: "å¯Œå±± â†’ é‡‘æ¾¤", note: "ç¾å ´è²·ç¥¨ï¼›äººå¤šæ™‚ææ—©æ’éšŠã€‚", map: "https://www.google.com/maps/search/?api=1&query=é‡‘æ¾¤ç«™" },
          { id: "d2-10", time: "19:00", title: "æ™šé¤ & ä¼‘æ¯", category: "food", place: "é‡‘æ¾¤", note: "å›é£¯åº—å¾Œæ•´ç†æˆ°åˆ©å“ã€‚", map: "https://www.google.com/maps/search/?api=1&query=é‡‘æ¾¤%20é¤å»³" },
        ],
        "2026-01-03": [
          { id: "d3-1", time: "09:00â€“10:00", title: "æ—©é¤ï¼šæ±å‡ºçˆç²åº—", category: "food", place: "é‡‘æ¾¤", note: "å»ºè­°ææ—©åˆ°é¿å…æ’éšŠã€‚", map: "https://www.google.com/maps/search/?api=1&query=æ±å‡ºçˆç²åº—" },
          { id: "d3-2", time: "10:30", title: "é‡‘æ¾¤ â†’ å¯Œå±±ï¼ˆç§»å‹•ï¼‰", category: "move", place: "é‡‘æ¾¤ â†’ å¯Œå±±", note: "åˆå‰ï½ä¸­åˆç§»å‹•ã€‚", map: "https://www.google.com/maps/search/?api=1&query=Toyama%20Station" },
          { id: "d3-3", time: "13:00", title: "å¯Œå±±å¸‚å€æ´»å‹•ï¼ˆå½ˆæ€§å®‰æ’ï¼‰", category: "sight", place: "å¯Œå±±å¸‚å€", note: "ä¾å¤©æ°£/é«”åŠ›å¾®èª¿ã€‚", map: "https://www.google.com/maps/search/?api=1&query=å¯Œå±±å¸‚" },
          { id: "d3-4", time: "19:00", title: "æ™šé¤ & ä¼‘æ¯", category: "food", place: "å¯Œå±±/é‡‘æ¾¤ï¼ˆä¾ä½å®¿ï¼‰", note: "æ—©ç¡ï¼Œéš”å¤©è¡Œç¨‹è¼ƒæ»¿ã€‚", map: "https://www.google.com/maps/search/?api=1&query=å¯Œå±±%20é¤å»³" },
        ],
        "2026-01-04": [
          { id: "d4-1", time: "10:00", title: "é‡‘æ¾¤ 21 ä¸–ç´€ç¾è¡“é¤¨", category: "sight", place: "é‡‘æ¾¤", note: "ç†±é–€å±•å€å¯å…ˆæŸ¥ç¥¨å‹™/é–‹é¤¨ã€‚", map: "https://www.google.com/maps/search/?api=1&query=21st%20Century%20Museum%20of%20Contemporary%20Art%20Kanazawa" },
          { id: "d4-2", time: "12:00", title: "Le MusÃ©e de H", category: "food", place: "é‡‘æ¾¤", note: "ç”œé»/å’–å•¡ã€‚", map: "https://www.google.com/maps/search/?api=1&query=Le%20Mus%C3%A9e%20de%20H%20Kanazawa" },
          { id: "d4-3", time: "13:30", title: "æ±èŒ¶å±‹è¡—ï¼ˆæ•£æ­¥é€›è¡—ï¼‰", category: "sight", place: "é‡‘æ¾¤", note: "æ‹ç…§è·¯ç·šé †èµ°ã€‚", map: "https://www.google.com/maps/search/?api=1&query=æ±èŒ¶å±‹è¡—%20é‡‘æ¾¤" },
          { id: "d4-4", time: "15:30", title: "å…¼å…­åœ’ & é‡‘æ¾¤åŸ", category: "sight", place: "é‡‘æ¾¤", note: "é»ƒæ˜æ™‚æ®µå…‰ç·šæ¼‚äº®ã€‚", map: "https://www.google.com/maps/search/?api=1&query=å…¼å…­åœ’" },
          { id: "d4-5", time: "17:30", title: "Kajimart è¶…å¸‚æ¡è³¼ â†’ å›é£¯åº—æ”¾æ±è¥¿", category: "move", place: "é‡‘æ¾¤", note: "è£œé›¶é£Ÿ/é£²æ–™/éš”å¤©è·¯ä¸Šé£Ÿç‰©ã€‚", map: "https://www.google.com/maps/search/?api=1&query=Kajimart%20é‡‘æ¾¤" },
          { id: "d4-6", time: "19:30", title: "ç¥ç¤¾åƒæ‹œ & ç‰‡ç”ºå‘¨é‚Šæ™ƒ", category: "sight", place: "é‡‘æ¾¤", note: "æ”¾é¬†æ”¶å°¾ã€‚", map: "https://www.google.com/maps/search/?api=1&query=é‡‘æ¾¤%20ç¥ç¤¾" },
        ],
        "2026-01-05": [
          { id: "d5-1", time: "08:00", title: "æ¸…æ™¨æ•´ç†è¡Œæã€æº–å‚™å‡ºé–€", category: "stay", place: "é‡‘æ¾¤", note: "é€€æˆ¿ã€æª¢æŸ¥å……é›»å™¨/è­·ç…§ã€‚", map: "" },
          { id: "d5-2", time: "09:30", title: "é‡‘æ¾¤ â†’ å°æ¾æ©Ÿå ´ï¼ˆå·´å£«ï¼‰", category: "move", place: "é‡‘æ¾¤ç«™ â†’ å°æ¾æ©Ÿå ´", note: "é ç•™å€™è»Šèˆ‡æ’éšŠæ™‚é–“ã€‚", map: "https://www.google.com/maps/search/?api=1&query=Komatsu%20Airport" },
          { id: "d5-3", time: "11:45â€“14:35", title: "âœˆï¸ é•·æ¦® BR157 å°æ¾ â†’ æ¡ƒåœ’äºŒèˆª", category: "move", place: "KMQ â†’ TPE", note: "å¹³å®‰å›å®¶ï½", map: "https://www.google.com/maps/search/?api=1&query=æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ç¬¬äºŒèˆªå»ˆ" },
        ],
      };

      // ---------- Bookings ----------
      const INITIAL_BOOKINGS = {
        flight: {
          airline: "EVA Air é•·æ¦®èˆªç©º",
          flightNoGo: "BR158",
          flightNoBack: "BR157",
          from: "TPE æ¡ƒåœ’ T2",
          to: "KMQ å°æ¾",
          departGo: "2026-01-01 06:35",
          arriveGo: "2026-01-01 10:25",
          departBack: "2026-01-05 11:45",
          arriveBack: "2026-01-05 14:35",
        },
        hotel: {
          name: "SOKI KANAZAWA",
          map: "https://maps.app.goo.gl/AiNn6tNwGVsXf5JUA",
          addressJa: "ã€’920-0909 çŸ³å·çœŒé‡‘æ²¢å¸‚è¢‹ç”º2-1",
          addressEn: "2-1 Fukuromachi, Kanazawa-shi, Ishikawa 920-0909, Japan",
          phone: "+81-76-210-0270",
          checkin: "15:00",
          checkout: "11:00",
        },
      };

      // ---------- UI Primitives ----------
      function Hero() {
        return (
          <div className="relative mx-auto max-w-md">
            <div className="safe-t" />
            <div className="relative h-52 overflow-hidden">
              <img
                src={HERO_IMAGE}
                alt="ç«‹å±±é€£å³°"
                className="h-full w-full object-cover"
                onError={(e) => {
                  e.currentTarget.style.display = "none";
                }}
              />
              <div className="absolute inset-0 bg-gradient-to-t from-sand-50 via-black/10 to-black/25" />
              <div className="absolute left-4 bottom-4 right-4">
                <div className="inline-flex items-center gap-2 rounded-full bg-white/75 px-3 py-1 text-xs font-semibold text-sand-800 ring-1 ring-white/70 backdrop-blur">
                  ğŸ”ï¸ ç«‹å±±é€£å³°
                </div>
                <div className="mt-2 text-2xl font-semibold tracking-tight text-white drop-shadow">
                  2026æ—¥æœ¬åŒ—é™¸æ—…è¡Œ
                </div>
              </div>
            </div>
          </div>
        );
      }

      function TopBar({ subtitle }) {
        return (
          <div className="sticky top-0 z-30 bg-sand-50/88 backdrop-blur-md">
            <div className="mx-auto max-w-md px-4 pt-3 pb-3">
              <div className="flex items-end justify-between gap-3">
                <div>
                  <div className="text-[13px] text-sand-600">{subtitle}</div>
                  <div className="text-xl font-semibold tracking-tight">2026æ—¥æœ¬åŒ—é™¸æ—…è¡Œ</div>
                </div>
                <div className="flex items-center gap-2">
                  <div className="rounded-full bg-white shadow-soft px-3 py-1 text-[12px] text-sand-700 ring-1 ring-sand-100">
                    é‡‘æ¾¤ãƒ»å¯Œå±±ãƒ»é«˜å±±
                  </div>
                </div>
              </div>
            </div>
            <div className="h-px bg-sand-100" />
          </div>
        );
      }

      function Card({ children, className }) {
        return (
          <div className={cx("rounded-xl2 bg-white shadow-soft ring-1 ring-sand-100", className)}>
            {children}
          </div>
        );
      }

      function Modal({ open, onClose, title, children }) {
        const ref = useRef(null);

        useEffect(() => {
          if (!open) return;
          const onKey = (e) => e.key === "Escape" && onClose();
          window.addEventListener("keydown", onKey);
          return () => window.removeEventListener("keydown", onKey);
        }, [open, onClose]);

        useEffect(() => {
          if (open) setTimeout(() => ref.current?.focus(), 0);
        }, [open]);

        if (!open) return null;

        return (
          <div className="fixed inset-0 z-50">
            <div className="absolute inset-0 bg-black/35" onClick={onClose} />
            <div className="absolute inset-x-0 bottom-0 mx-auto max-w-md px-3 pb-3 safe-b">
              <div
                className="grain relative rounded-2xl bg-sand-50 shadow-soft2 ring-1 ring-sand-200 outline-none"
                tabIndex={-1}
                ref={ref}
              >
                <div className="flex items-center justify-between px-4 pt-4">
                  <div className="text-base font-semibold">{title}</div>
                  <button
                    onClick={onClose}
                    className="rounded-full bg-white/80 px-3 py-1 text-sm ring-1 ring-sand-200 hover:bg-white"
                  >
                    é—œé–‰
                  </button>
                </div>
                <div className="px-4 pb-4 pt-3">{children}</div>
              </div>
            </div>
          </div>
        );
      }

      function TabBar({ tab, setTab }) {
        const items = [
          { key: "schedule", label: "è¡Œç¨‹", icon: "ğŸ—“ï¸" },
          { key: "bookings", label: "é è¨‚", icon: "ğŸ«" },
          { key: "expense", label: "è¨˜å¸³", icon: "ğŸ§¾" },
        ];
        return (
          <div className="safe-b fixed inset-x-0 bottom-0 z-40 bg-sand-50/90 backdrop-blur-md">
            <div className="mx-auto max-w-md px-4 pb-2 pt-2">
              <div className="grid grid-cols-3 gap-2 rounded-2xl bg-white shadow-soft ring-1 ring-sand-100 p-2">
                {items.map((it) => {
                  const active = tab === it.key;
                  return (
                    <button
                      key={it.key}
                      onClick={() => setTab(it.key)}
                      className={cx(
                        "rounded-2xl px-3 py-2 text-sm font-medium transition",
                        active ? "bg-moss-600 text-white shadow-soft" : "bg-sand-50 text-sand-800 hover:bg-sand-100"
                      )}
                    >
                      <div className="flex items-center justify-center gap-2">
                        <span className={cx("text-base", active ? "" : "opacity-90")}>{it.icon}</span>
                        <span>{it.label}</span>
                      </div>
                    </button>
                  );
                })}
              </div>
            </div>
          </div>
        );
      }

      // ---------- Weather (Open-Meteo) ----------
      function codeToText(code) {
        const m = {
          0: { icon: "â˜€ï¸", label: "æ™´" },
          1: { icon: "ğŸŒ¤ï¸", label: "å¤§è‡´æ™´" },
          2: { icon: "â›…ï¸", label: "å±€éƒ¨å¤šé›²" },
          3: { icon: "â˜ï¸", label: "å¤šé›²" },
          45: { icon: "ğŸŒ«ï¸", label: "éœ§" },
          48: { icon: "ğŸŒ«ï¸", label: "éœ§ï¼ˆéœœï¼‰" },
          51: { icon: "ğŸŒ¦ï¸", label: "æ¯›æ¯›é›¨" },
          53: { icon: "ğŸŒ¦ï¸", label: "æ¯›æ¯›é›¨" },
          55: { icon: "ğŸŒ§ï¸", label: "æ¯›æ¯›é›¨ï¼ˆå¼·ï¼‰" },
          61: { icon: "ğŸŒ§ï¸", label: "å°é›¨" },
          63: { icon: "ğŸŒ§ï¸", label: "ä¸­é›¨" },
          65: { icon: "ğŸŒ§ï¸", label: "å¤§é›¨" },
          71: { icon: "ğŸŒ¨ï¸", label: "å°é›ª" },
          73: { icon: "ğŸŒ¨ï¸", label: "ä¸­é›ª" },
          75: { icon: "â„ï¸", label: "å¤§é›ª" },
          80: { icon: "ğŸŒ¦ï¸", label: "é™£é›¨" },
          81: { icon: "ğŸŒ§ï¸", label: "é™£é›¨ï¼ˆå¼·ï¼‰" },
          82: { icon: "â›ˆï¸", label: "é›·é›¨" },
          95: { icon: "â›ˆï¸", label: "é›·é›¨" },
          96: { icon: "â›ˆï¸", label: "é›·é›¨ï¼ˆå†°é›¹ï¼‰" },
          99: { icon: "â›ˆï¸", label: "é›·é›¨ï¼ˆå†°é›¹ï¼‰" },
        };
        return m[code] || { icon: "ğŸŒ¤ï¸", label: "å¤©æ°£" };
      }

      function WeatherCard({ dayKey }) {
        const [state, setState] = useState({ status: "idle", data: null, err: "" });
        const cacheRef = useRef(new Map());

        useEffect(() => {
          const loc = LOC_BY_DAY[dayKey] || LOC_BY_DAY["2026-01-01"];
          const cacheKey = `${dayKey}@${loc.lat},${loc.lon}`;
          const cached = cacheRef.current.get(cacheKey);
          if (cached) {
            setState({ status: "ok", data: cached, err: "" });
            return;
          }

          let aborted = false;
          (async () => {
            try {
              setState({ status: "loading", data: null, err: "" });
              const url =
                "https://api.open-meteo.com/v1/forecast" +
                `?latitude=${encodeURIComponent(loc.lat)}` +
                `&longitude=${encodeURIComponent(loc.lon)}` +
                `&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max` +
                `&timezone=${encodeURIComponent("Asia/Tokyo")}` +
                `&start_date=${encodeURIComponent(dayKey)}` +
                `&end_date=${encodeURIComponent(dayKey)}`;

              const res = await fetch(url);
              if (!res.ok) throw new Error(`Weather API error: ${res.status}`);
              const json = await res.json();

              const d = {
                city: loc.name,
                date: json?.daily?.time?.[0] || dayKey,
                code: json?.daily?.weathercode?.[0],
                hi: json?.daily?.temperature_2m_max?.[0],
                lo: json?.daily?.temperature_2m_min?.[0],
                pop: json?.daily?.precipitation_probability_max?.[0],
              };

              cacheRef.current.set(cacheKey, d);
              if (!aborted) setState({ status: "ok", data: d, err: "" });
            } catch (e) {
              if (!aborted) setState({ status: "error", data: null, err: e?.message || "Unknown error" });
            }
          })();

          return () => { aborted = true; };
        }, [dayKey]);

        return (
          <Card className="p-4">
            <div className="flex items-center justify-between gap-4">
              <div>
                <div className="text-sm text-sand-600">å¤©æ°£</div>

                {state.status === "loading" && (
                  <div className="mt-2">
                    <div className="h-4 w-36 rounded bg-sand-100" />
                    <div className="mt-2 h-3 w-52 rounded bg-sand-100" />
                  </div>
                )}

                {state.status === "error" && (
                  <div className="mt-2 text-sm text-clay-700">
                    è®€å–å¤©æ°£å¤±æ•—ï¼ˆ{state.err}ï¼‰
                  </div>
                )}

                {state.status === "ok" && state.data && (
                  <>
                    <div className="mt-1 flex items-baseline gap-2">
                      <div className="text-2xl">{codeToText(state.data.code).icon}</div>
                      <div className="text-lg font-semibold">
                        {codeToText(state.data.code).label}
                        <span className="ml-2 text-sm font-medium text-sand-600">Â· {state.data.city}</span>
                      </div>
                    </div>
                    <div className="mt-1 text-sm text-sand-700">
                      {Math.round(state.data.lo)}Â°C â€“ {Math.round(state.data.hi)}Â°C
                      <span className="mx-2 text-sand-300">â€¢</span>
                      é™é›¨ {state.data.pop ?? "â€”"}%
                    </div>
                  </>
                )}
              </div>

              <div className="text-right">
                <div className="text-xs text-sand-500">å¿«é€Ÿæç¤º</div>
                <div className="mt-1 text-sm font-medium text-sand-800">
                  {state.status === "ok" && state.data?.pop >= 50 ? "å¸¶å‚˜/é˜²æ°´é‹" : "åˆ†å±¤ä¿æš–"}
                </div>
              </div>
            </div>
          </Card>
        );
      }

      // ---------- Schedule Tab ----------
      function DateStrip({ selected, onSelect }) {
        return (
          <div className="no-scrollbar -mx-4 overflow-x-auto px-4">
            <div className="flex gap-2 py-2">
              {TRIP_DAYS.map((d) => {
                const active = d.key === selected;
                return (
                  <button
                    key={d.key}
                    onClick={() => onSelect(d.key)}
                    className={cx(
                      "shrink-0 rounded-2xl px-4 py-2 text-sm font-medium ring-1 transition",
                      active ? "bg-moss-600 text-white ring-moss-600 shadow-soft" : "bg-white text-sand-800 ring-sand-100 hover:bg-sand-50"
                    )}
                  >
                    {d.label}
                  </button>
                );
              })}
            </div>
          </div>
        );
      }

      function TimelineItem({ item, onClick }) {
        const meta = CATEGORY[item.category] ?? CATEGORY.sight;
        return (
          <button
            onClick={onClick}
            className="w-full text-left rounded-2xl bg-white ring-1 ring-sand-100 shadow-soft px-4 py-3 hover:bg-sand-50 transition"
          >
            <div className="flex items-start gap-3">
              <div className="mt-1 flex flex-col items-center">
                <div className={cx("h-3 w-3 rounded-full", meta.dot)} />
                <div className="mt-2 h-10 w-px bg-sand-100" />
              </div>

              <div className="min-w-0 flex-1">
                <div className="flex items-center justify-between gap-3">
                  <div className="text-sm font-semibold text-sand-900">{item.time}</div>
                  <span className={cx("shrink-0 rounded-full px-2 py-1 text-[12px] font-semibold", meta.pill)}>
                    {meta.label}
                  </span>
                </div>
                <div className="mt-1 text-[15px] font-semibold leading-snug">{item.title}</div>
                <div className="mt-1 text-sm text-sand-600 truncate">{item.place}</div>
              </div>

              <div className="mt-1 shrink-0 text-sand-400">â€º</div>
            </div>
          </button>
        );
      }

      function ScheduleTab({ scheduleByDay, updateNote }) {
        const [dayKey, setDayKey] = useState(TRIP_DAYS[0].key);
        const [selectedItem, setSelectedItem] = useState(null);
        const items = scheduleByDay[dayKey] ?? [];

        const [noteDraft, setNoteDraft] = useState("");
        useEffect(() => {
          if (!selectedItem) return;
          setNoteDraft(selectedItem.note || "");
        }, [selectedItem]);

        const onSaveNote = () => {
          if (!selectedItem) return;
          updateNote(dayKey, selectedItem.id, noteDraft);
          setSelectedItem((s) => (s ? { ...s, note: noteDraft } : s));
        };

        return (
          <div className="mx-auto max-w-md px-4 pb-28 pt-4">
            <DateStrip selected={dayKey} onSelect={setDayKey} />

            <div className="mt-2">
              <WeatherCard dayKey={dayKey} />
            </div>

            <div className="mt-4 flex items-center justify-between">
              <div className="text-base font-semibold">{TRIP_DAYS.find((d) => d.key === dayKey)?.label}</div>
              <div className="text-xs text-sand-500">{items.length} å€‹é …ç›®</div>
            </div>

            <div className="mt-3 space-y-3">
              {items.map((it) => (
                <TimelineItem key={it.id} item={it} onClick={() => setSelectedItem(it)} />
              ))}
            </div>

            <Modal open={!!selectedItem} onClose={() => setSelectedItem(null)} title="è¡Œç¨‹è©³æƒ…">
              {selectedItem && (
                <div className="space-y-3">
                  <div className="flex items-start justify-between gap-3">
                    <div>
                      <div className="text-sm text-sand-600">{selectedItem.time}</div>
                      <div className="mt-1 text-lg font-semibold leading-snug">{selectedItem.title}</div>
                      <div className="mt-1 text-sm text-sand-700">{selectedItem.place}</div>
                    </div>
                    <span
                      className={cx(
                        "shrink-0 rounded-full px-3 py-1 text-[12px] font-semibold",
                        (CATEGORY[selectedItem.category] ?? CATEGORY.sight).pill
                      )}
                    >
                      {(CATEGORY[selectedItem.category] ?? CATEGORY.sight).label}
                    </span>
                  </div>

                  <Card className="p-3">
                    <div className="text-xs text-sand-500">å‚™è¨»ï¼ˆå¯ç·¨è¼¯ï¼‰</div>
                    <textarea
                      value={noteDraft}
                      onChange={(e) => setNoteDraft(e.target.value)}
                      rows={4}
                      placeholder="ä¾‹å¦‚ï¼šè¦è²·çš„æ±è¥¿ã€é›†åˆæ™‚é–“æé†’ã€å‚™ç”¨æ–¹æ¡ˆâ€¦"
                      className="mt-2 w-full rounded-2xl bg-white px-3 py-3 text-sm leading-relaxed ring-1 ring-sand-100 focus:outline-none"
                    />
                    <div className="mt-2 flex gap-2">
                      <button
                        onClick={onSaveNote}
                        className="flex-1 rounded-2xl bg-moss-600 px-4 py-3 text-sm font-semibold text-white shadow-soft hover:bg-moss-700"
                      >
                        å„²å­˜å‚™è¨»
                      </button>
                      <button
                        onClick={() => setNoteDraft(selectedItem.note || "")}
                        className="flex-1 rounded-2xl bg-white px-4 py-3 text-sm font-semibold shadow-soft ring-1 ring-sand-100 hover:bg-sand-50"
                      >
                        é‚„åŸ
                      </button>
                    </div>
                  </Card>

                  <div className="flex gap-2">
                    <a
                      href={selectedItem.map || "#"}
                      target="_blank"
                      rel="noreferrer"
                      className={cx(
                        "flex-1 rounded-2xl px-4 py-3 text-center text-sm font-semibold shadow-soft ring-1 transition",
                        selectedItem.map ? "bg-moss-600 text-white ring-moss-600 hover:bg-moss-700" : "bg-sand-100 text-sand-400 ring-sand-200 pointer-events-none"
                      )}
                    >
                      æ‰“é–‹åœ°åœ–
                    </a>
                  </div>
                </div>
              )}
            </Modal>
          </div>
        );
      }

      // ---------- Bookings Tab ----------
      function BoardingPass({ flight, direction }) {
        const isGo = direction === "go";
        const from = isGo ? flight.from : flight.to;
        const to = isGo ? flight.to : flight.from;
        const no = isGo ? flight.flightNoGo : flight.flightNoBack;
        const depart = isGo ? flight.departGo : flight.departBack;
        const arrive = isGo ? flight.arriveGo : flight.arriveBack;

        return (
          <div className="relative overflow-hidden rounded-2xl bg-gradient-to-br from-moss-700 to-moss-600 text-white shadow-soft">
            <div className="grain absolute inset-0 opacity-80" />
            <div className="relative p-4">
              <div className="flex items-start justify-between">
                <div>
                  <div className="text-xs text-white/80">{flight.airline}</div>
                  <div className="mt-1 text-lg font-semibold tracking-tight">Boarding Pass</div>
                </div>
                <div className="rounded-full bg-white/15 px-3 py-1 text-xs font-semibold ring-1 ring-white/25">
                  {isGo ? "å»ç¨‹" : "å›ç¨‹"} Â· {no}
                </div>
              </div>

              <div className="mt-4 grid grid-cols-3 items-center gap-3">
                <div>
                  <div className="text-xs text-white/70">From</div>
                  <div className="mt-1 text-base font-semibold">{from.split(" ")[0]}</div>
                  <div className="text-xs text-white/70">{from.replace(from.split(" ")[0], "").trim()}</div>
                </div>
                <div className="text-center">
                  <div className="text-2xl">âœˆï¸</div>
                  <div className="mt-1 text-xs text-white/70">Non-stop</div>
                </div>
                <div className="text-right">
                  <div className="text-xs text-white/70">To</div>
                  <div className="mt-1 text-base font-semibold">{to.split(" ")[0]}</div>
                  <div className="text-xs text-white/70">{to.replace(to.split(" ")[0], "").trim()}</div>
                </div>
              </div>

              <div className="mt-4 grid grid-cols-2 gap-3">
                <div className="rounded-2xl bg-white/12 p-3 ring-1 ring-white/20">
                  <div className="text-xs text-white/70">Depart</div>
                  <div className="mt-1 text-sm font-semibold">{depart}</div>
                </div>
                <div className="rounded-2xl bg-white/12 p-3 ring-1 ring-white/20">
                  <div className="text-xs text-white/70">Arrive</div>
                  <div className="mt-1 text-sm font-semibold">{arrive}</div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      function HotelCardLite({ hotel }) {
        return (
          <Card className="p-4 space-y-3">
            <div className="flex items-start justify-between gap-3">
              <div>
                <div className="text-sm text-sand-600">ä½å®¿</div>
                <div className="mt-1 text-base font-semibold">{hotel.name}</div>
              </div>
              <div className="rounded-2xl bg-sand-50 px-3 py-2 ring-1 ring-sand-100 text-right">
                <div className="text-[11px] text-sand-500">Check-in / out</div>
                <div className="mt-0.5 text-sm font-semibold">{hotel.checkin} / {hotel.checkout}</div>
              </div>
            </div>

            <div className="rounded-2xl bg-white p-3 ring-1 ring-sand-100">
              <div className="text-xs text-sand-500">ä½æ‰€ï¼ˆæ—¥æœ¬èªï¼‰</div>
              <div className="mt-1 text-sm text-sand-800">{hotel.addressJa}</div>
            </div>

            <div className="rounded-2xl bg-white p-3 ring-1 ring-sand-100">
              <div className="text-xs text-sand-500">Address (English)</div>
              <div className="mt-1 text-sm text-sand-800">{hotel.addressEn}</div>
            </div>

            <div className="rounded-2xl bg-white p-3 ring-1 ring-sand-100">
              <div className="text-xs text-sand-500">é›»è©± / Phone</div>
              <div className="mt-1 text-sm font-semibold text-sand-800">{hotel.phone}</div>
            </div>

            <a
              href={hotel.map}
              target="_blank"
              rel="noreferrer"
              className="block w-full rounded-2xl bg-moss-600 px-4 py-3 text-center text-sm font-semibold text-white shadow-soft hover:bg-moss-700"
            >
              æ‰“é–‹åœ°åœ–
            </a>
          </Card>
        );
      }

      function BookingsTab() {
        const [bookings] = useState(INITIAL_BOOKINGS);

        return (
          <div className="mx-auto max-w-md px-4 pb-28 pt-4 space-y-4">
            <div className="flex items-center justify-between">
              <div>
                <div className="text-sm text-sand-600">æ©Ÿç¥¨</div>
                <div className="text-base font-semibold">ç™»æ©Ÿè­‰</div>
              </div>
              <div className="text-xs text-sand-500">BR158 / BR157</div>
            </div>

            <BoardingPass flight={bookings.flight} direction="go" />
            <BoardingPass flight={bookings.flight} direction="back" />

            <HotelCardLite hotel={bookings.hotel} />
          </div>
        );
      }

      // ---------- Expense Tab ----------
      const PEOPLE = ["æ²ˆ", "ç‘„", "YO"];

      // âœ… ä½ è¦çš„ç®—æ³•ï¼šé€ç­†æ¬ æ¬¾ â†’ å…©å…©äº’ç›¸æŠµéŠ·ï¼ˆç¬¦åˆä½ èˆ‰ä¾‹ï¼‰
      function computeSettlement(entries) {
        // 1) é€ç­†ç´¯ç©ã€Œèª°æ¬ èª°ã€ï¼šdebts[from][to] += amount
        const debts = Object.fromEntries(
          PEOPLE.map((from) => [
            from,
            Object.fromEntries(PEOPLE.map((to) => [to, 0])),
          ])
        );

        for (const e of entries) {
          const payer = e.payer;
          for (const p of PEOPLE) {
            if (p === payer) continue;
            const amt = Number(e.allocations?.[p] || 0);
            debts[p][payer] += amt; // p æ¬  payer
          }
        }

        // 2) å…©å…©äº’ç›¸æŠµéŠ·ï¼ˆpairwise nettingï¼‰
        const net = Object.fromEntries(
          PEOPLE.map((from) => [
            from,
            Object.fromEntries(PEOPLE.map((to) => [to, 0])),
          ])
        );

        for (let i = 0; i < PEOPLE.length; i++) {
          for (let j = i + 1; j < PEOPLE.length; j++) {
            const a = PEOPLE[i];
            const b = PEOPLE[j];
            const aToB = debts[a][b];
            const bToA = debts[b][a];
            const diff = aToB - bToA;

            if (diff > 0) {
              net[a][b] = diff; // a æ¬  b
              net[b][a] = 0;
            } else if (diff < 0) {
              net[b][a] = -diff; // b æ¬  a
              net[a][b] = 0;
            } else {
              net[a][b] = 0;
              net[b][a] = 0;
            }
          }
        }

        // 3) incoming[to][from]ï¼šfrom è¦çµ¦ to å¤šå°‘ï¼ˆç”¨æ–¼é•·æ¢ä¸‹æ–¹é¡¯ç¤ºï¼‰
        const incoming = Object.fromEntries(
          PEOPLE.map((to) => [
            to,
            Object.fromEntries(PEOPLE.map((from) => [from, 0])),
          ])
        );

        for (const from of PEOPLE) {
          for (const to of PEOPLE) {
            incoming[to][from] = net[from][to];
          }
        }

        // 4) transfersï¼ˆæ¢åˆ—ç‰ˆï¼‰
        const transfers = [];
        for (const from of PEOPLE) {
          for (const to of PEOPLE) {
            const amount = net[from][to];
            if (from !== to && amount > 0) transfers.push({ from, to, amount });
          }
        }

        // 5) é¡å¤–ç®— paid/owed/balanceï¼ˆä¿ç•™å¯èƒ½éœ€è¦ï¼‰
        const paid = Object.fromEntries(PEOPLE.map((p) => [p, 0]));
        const owed = Object.fromEntries(PEOPLE.map((p) => [p, 0]));
        for (const e of entries) {
          paid[e.payer] += Number(e.total || 0);
          for (const p of PEOPLE) owed[p] += Number(e.allocations?.[p] || 0);
        }
        const balance = Object.fromEntries(PEOPLE.map((p) => [p, paid[p] - owed[p]]));

        return { paid, owed, balance, transfers, incoming };
      }

function ExpenseTab() {
  // --- 1. Firebase é…ç½® ---
  const firebaseConfig = {
    apiKey: "AIzaSyDxY8B0DBksYyCR0CVMuJjxAoRU-z6oF-A",
    authDomain: "japan-trip-2026-c5760.firebaseapp.com",
    databaseURL: "https://japan-trip-2026-c5760-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "japan-trip-2026-c5760",
    storageBucket: "japan-trip-2026-c5760.firebasestorage.app",
    messagingSenderId: "955400726204",
    appId: "1:955400726204:web:56c4d76cfe1800c42212b9"
  };

  // ç¢ºä¿åªåˆå§‹åŒ–ä¸€æ¬¡
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  const db = firebase.database();
  const expenseRef = db.ref("shared_expenses");

  // --- 2. ç‹€æ…‹ç®¡ç† ---
  const [entries, setEntries] = useState([]);
  const [form, setForm] = useState({
    dateKey: TRIP_DAYS[0].key,
    title: "",
    payer: "æ²ˆ",
    total: "",
    allocations: { "æ²ˆ": "", "ç‘„": "", "YO": "" }
  });

  // --- 3. æ ¸å¿ƒåŒæ­¥é‚è¼¯ ---
  useEffect(() => {
    // ç›£è½é›²ç«¯è³‡æ–™åº«
    expenseRef.on('value', (snapshot) => {
      const val = snapshot.val();
      setEntries(val || []);
    });
    return () => expenseRef.off();
  }, []);

  // è¨ˆç®—é‚è¼¯ (ç¶­æŒä½ åŸæœ¬ç²¾å¯†çš„ç®—æ³•)
  const totalsByPayer = useMemo(() => {
    const m = Object.fromEntries(PEOPLE.map((p) => [p, 0]));
    for (const e of entries) m[e.payer] += Number(e.total || 0);
    return m;
  }, [entries]);

  const settlement = useMemo(() => computeSettlement(entries), [entries]);

  const dashboard = useMemo(() => {
    const values = PEOPLE.map((p) => totalsByPayer[p] || 0);
    const max = Math.max(1, ...values);
    const sum = values.reduce((a, b) => a + b, 0);
    return { values, max, sum };
  }, [totalsByPayer]);

  const grouped = useMemo(() => {
    const m = new Map();
    for (const e of entries) {
      const k = e.dateKey;
      if (!m.has(k)) m.set(k, []);
      m.get(k).push(e);
    }
    return m;
  }, [entries]);

  const formNums = useMemo(() => {
    const total = Number(form.total || 0);
    let allocSum = 0;
    for (const p of PEOPLE) allocSum += Number(form.allocations[p] || 0);
    return { total, allocSum, remaining: total - allocSum };
  }, [form]);

  // --- 4. æ“ä½œå‹•ä½œ ---
  const splitEven = () => {
    const total = Number(form.total || 0);
    if (!total) return;
    const per = Math.floor(total / PEOPLE.length);
    const rem = total - per * PEOPLE.length;
    const next = { ...form.allocations };
    PEOPLE.forEach((p, i) => {
      next[p] = i === 0 ? per + rem : per;
    });
    setForm({ ...form, allocations: next });
  };

  const setAlloc = (p, v) => {
    setForm({ ...form, allocations: { ...form.allocations, [p]: v } });
  };

  const addEntry = () => {
    const total = Number(form.total);
    if (!total || total <= 0) return alert("è«‹è¼¸å…¥ç¸½é‡‘é¡");
    if (!form.title.trim()) return alert("è«‹è¼¸å…¥é …ç›®åç¨±");
    if (Math.abs(formNums.allocSum - total) > 0.1) {
      return alert(`åˆ†é…åŠ ç¸½(${formNums.allocSum})ä¸ç­‰æ–¼ç¸½é‡‘é¡(${total})`);
    }

    const newEntry = {
      id: "e" + Math.random().toString(16).slice(2),
      dateKey: form.dateKey,
      title: form.title.trim(),
      payer: form.payer,
      total,
      allocations: Object.fromEntries(PEOPLE.map((p) => [p, Number(form.allocations[p] || 0)]))
    };

    // åŒæ­¥åˆ° Firebase
    expenseRef.set([...entries, newEntry]);

    // é‡ç½®è¡¨å–®
    setForm({
      ...form,
      title: "",
      total: "",
      allocations: { "æ²ˆ": "", "ç‘„": "", "YO": "" }
    });
  };

  const removeEntry = (id) => {
    if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†å¸³ç›®å—ï¼Ÿ")) return;
    const next = entries.filter((e) => e.id !== id);
    expenseRef.set(next);
  };

  // --- 5. UI æ¸²æŸ“ (é€™è£¡æ˜¯ä½ åŸæœ¬ç²¾ç¾çš„ Tailwind ä»‹é¢) ---
  return (
    <div className="pb-24 animate-in fade-in duration-500">
      {/* é ‚éƒ¨ Dashboard */}
      <div className="bg-white rounded-2xl p-6 mb-6 shadow-soft border border-sand-100">
        <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center">
          <span className="w-1.5 h-5 bg-sand-500 rounded-full mr-2"></span>
          æ”¯å‡ºæ¦‚è¦½ (Total: Â¥{dashboard.sum.toLocaleString()})
        </h3>
        <div className="space-y-4">
          {PEOPLE.map((p, i) => (
            <div key={p}>
              <div className="flex justify-between text-sm mb-1">
                <span className="font-medium text-slate-600">{p} ä»˜å‡º</span>
                <span className="text-slate-500 font-mono">Â¥{dashboard.values[i].toLocaleString()}</span>
              </div>
              <div className="h-2 bg-slate-100 rounded-full overflow-hidden">
                <div 
                  className="h-full bg-sand-400 transition-all duration-1000"
                  style={{ width: `${(dashboard.values[i] / dashboard.max) * 100}%` }}
                />
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* çµç®—å»ºè­° */}
      {settlement.length > 0 && (
        <div className="bg-sand-50 rounded-2xl p-5 mb-6 border border-sand-200">
          <h3 className="text-sm font-bold text-sand-700 mb-3 uppercase tracking-wider">çµç®—å»ºè­°</h3>
          <div className="space-y-2">
            {settlement.map((s, i) => (
              <div key={i} className="flex items-center text-slate-700 bg-white/50 p-2 rounded-lg">
                <span className="font-bold text-sand-600">{s.from}</span>
                <span className="mx-2 text-slate-400">â”</span>
                <span className="font-bold text-slate-700">{s.to}</span>
                <span className="ml-auto font-mono font-bold text-sand-700">Â¥{s.amount.toLocaleString()}</span>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* æ–°å¢å¸³ç›®è¡¨å–® */}
      <div className="bg-white rounded-2xl p-6 mb-6 shadow-soft border border-sand-100">
        <h3 className="text-lg font-bold text-slate-800 mb-4">æ–°å¢è¨˜å¸³</h3>
        <div className="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label className="block text-xs font-bold text-slate-400 mb-1 uppercase">æ—¥æœŸ</label>
            <select 
              className="w-full border-slate-200 rounded-xl bg-slate-50 text-sm p-2"
              value={form.dateKey}
              onChange={(e) => setForm({...form, dateKey: e.target.value})}
            >
              {TRIP_DAYS.map(d => <option key={d.key} value={d.key}>{d.label}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-xs font-bold text-slate-400 mb-1 uppercase">ä»˜æ¬¾äºº</label>
            <select 
              className="w-full border-slate-200 rounded-xl bg-slate-50 text-sm p-2"
              value={form.payer}
              onChange={(e) => setForm({...form, payer: e.target.value})}
            >
              {PEOPLE.map(p => <option key={p} value={p}>{p}</option>)}
            </select>
          </div>
        </div>
        <div className="mb-4">
          <label className="block text-xs font-bold text-slate-400 mb-1 uppercase">é …ç›®åç¨±</label>
          <input 
            type="text"
            className="w-full border-slate-200 rounded-xl bg-slate-50 text-sm p-2"
            placeholder="ä¾‹å¦‚ï¼šä¸€è˜­æ‹‰éºµ"
            value={form.title}
            onChange={(e) => setForm({...form, title: e.target.value})}
          />
        </div>
        <div className="mb-6">
          <div className="flex justify-between items-end mb-1">
            <label className="text-xs font-bold text-slate-400 uppercase">ç¸½é‡‘é¡ (JPY)</label>
            <button onClick={splitEven} className="text-[10px] bg-slate-800 text-white px-2 py-1 rounded-md hover:bg-black transition-colors">
              å¹³å‡åˆ†é…
            </button>
          </div>
          <input 
            type="number"
            className="w-full border-slate-200 rounded-xl bg-slate-50 text-lg font-mono p-2"
            placeholder="0"
            value={form.total}
            onChange={(e) => setForm({...form, total: e.target.value})}
          />
        </div>

        <div className="space-y-3 mb-6 bg-slate-50 p-4 rounded-xl">
          <div className="text-xs font-bold text-slate-400 mb-2 uppercase">è²»ç”¨åˆ†æ”¤</div>
          {PEOPLE.map(p => (
            <div key={p} className="flex items-center gap-3">
              <span className="w-8 text-sm font-medium text-slate-600">{p}</span>
              <input 
                type="number"
                className="flex-1 border-slate-200 rounded-lg text-sm p-1.5"
                placeholder="é‡‘é¡"
                value={form.allocations[p]}
                onChange={(e) => setAlloc(p, e.target.value)}
              />
            </div>
          ))}
          <div className={`text-[10px] font-bold text-right ${formNums.remaining === 0 ? 'text-emerald-500' : 'text-rose-400'}`}>
            {formNums.remaining === 0 ? 'âœ“ åˆ†é…å®Œç•¢' : `å‰©é¤˜å¾…åˆ†é…: Â¥${formNums.remaining}`}
          </div>
        </div>

        <button 
          onClick={addEntry}
          className="w-full bg-sand-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-sand-200 active:transform active:scale-[0.98] transition-all"
        >
          æ–°å¢åˆ°åˆ—è¡¨
        </button>
      </div>

      {/* æ­·å²åˆ—è¡¨ */}
      <div className="space-y-6">
        {TRIP_DAYS.map(day => {
          const dayEntries = grouped.get(day.key) || [];
          if (dayEntries.length === 0) return null;
          return (
            <div key={day.key}>
              <div className="flex items-center mb-3">
                <div className="h-px flex-1 bg-slate-200"></div>
                <span className="mx-3 text-xs font-bold text-slate-400 uppercase tracking-widest">{day.label}</span>
                <div className="h-px flex-1 bg-slate-200"></div>
              </div>
              <div className="space-y-3">
                {dayEntries.map(e => (
                  <div key={e.id} className="bg-white rounded-xl p-4 shadow-sm border border-slate-100 flex justify-between items-center group">
                    <div>
                      <div className="text-sm font-bold text-slate-800">{e.title}</div>
                      <div className="text-[10px] text-slate-400 mt-0.5">
                        ç”± <span className="text-sand-600 font-bold">{e.payer}</span> æ”¯ä»˜ Â¥{e.total.toLocaleString()}
                      </div>
                    </div>
                    <div className="flex items-center gap-4">
                      <div className="text-right">
                        <div className="text-sm font-mono font-bold text-slate-700">Â¥{e.total.toLocaleString()}</div>
                      </div>
                      <button 
                        onClick={() => removeEntry(e.id)}
                        className="p-2 text-slate-300 hover:text-rose-400 transition-colors"
                      >
                        <i className="fas fa-trash-alt text-xs"></i>
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
}

      // ---------- App Shell ----------
      function App() {
        // Schedule state + persisted notes
        const savedNotes = useMemo(() => loadJSON("trip_notes_map_v1", {}), []);
        const [scheduleByDay, setScheduleByDay] = useState(() => {
          const cloned = JSON.parse(JSON.stringify(INITIAL_SCHEDULE));
          for (const dayKey of Object.keys(cloned)) {
            for (const item of cloned[dayKey]) {
              const key = `${dayKey}::${item.id}`;
              if (savedNotes[key] != null) item.note = savedNotes[key];
            }
          }
          return cloned;
        });

        const updateNote = (dayKey, itemId, note) => {
          setScheduleByDay((prev) => {
            const next = JSON.parse(JSON.stringify(prev));
            const arr = next[dayKey] || [];
            const idx = arr.findIndex((x) => x.id === itemId);
            if (idx >= 0) arr[idx].note = note;
            return next;
          });
          const key = `${dayKey}::${itemId}`;
          const nextNotes = { ...loadJSON("trip_notes_map_v1", {}), [key]: note };
          saveJSON("trip_notes_map_v1", nextNotes);
        };

        const [tab, setTab] = useState("schedule");

        const subtitle = useMemo(() => {
          if (tab === "schedule") return "è¡Œç¨‹";
          if (tab === "bookings") return "é è¨‚";
          return "è¨˜å¸³";
        }, [tab]);

        return (
          <div className="min-h-screen">
            <Hero />
            <TopBar subtitle={subtitle} />

            {tab === "schedule" && <ScheduleTab scheduleByDay={scheduleByDay} updateNote={updateNote} />}
            {tab === "bookings" && <BookingsTab />}
            {tab === "expense" && <ExpenseTab />}

            <TabBar tab={tab} setTab={setTab} />
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
