<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3F5B3B" />

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <meta name="apple-mobile-web-app-title" content="2026æ—¥æœ¬åŒ—é™¸" />
  <title>2026æ—¥æœ¬åŒ—é™¸æ—…è¡Œ</title>

  <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/ex0919544905-pixel/japan2026-1/main/%E6%97%A5%E6%9C%AC%E5%8C%97%E9%99%B8.png">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          boxShadow: {
            soft: "0 10px 25px rgba(0,0,0,.08)",
            soft2: "0 6px 18px rgba(0,0,0,.10)",
          },
          borderRadius: {
            xl2: "1.25rem",
          },
          colors: {
            sand: {
              50: "#FAF7F0",
              100: "#F3ECDD",
              200: "#E9DEC4",
              300: "#DCC9A2",
              400: "#CDB07F",
              500: "#B28E58",
              600: "#8F6F3F",
              700: "#6E5631",
              800: "#4B3B22",
              900: "#2A2115",
            },
            moss: {
              50: "#F3F7F2",
              100: "#E2EBDD",
              200: "#C1D3B8",
              300: "#9BB58C",
              400: "#76966A",
              500: "#5C7F52",
              600: "#46623F",
              700: "#364B30",
              800: "#263421",
              900: "#162012",
            },
            clay: {
              50: "#FBF6F2",
              100: "#F4E7DF",
              200: "#EBCFBE",
              300: "#DBB19B",
              400: "#C98E72",
              500: "#B56E4E",
              600: "#8E563C",
              700: "#6D4230",
              800: "#4C2E22",
              900: "#2C1B14",
            },
          },
        },
      },
    };
  </script>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    .safe-b {
      padding-bottom: max(16px, env(safe-area-inset-bottom));
    }
    .safe-t {
      padding-top: max(16px, env(safe-area-inset-top));
    }
    .grain::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="https://www.w3.org/2000/svg" width="120" height="120"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency=".8" numOctaves="2" stitchTiles="stitch"/></filter><rect width="120" height="120" filter="url(%23n)" opacity=".06"/></svg>');
      pointer-events: none;
      mix-blend-mode: multiply;
    }
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
  </style>
</head>

<body class="bg-sand-50 text-sand-900">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    // ---------- Firebase Configuration ----------
    const firebaseConfig = {
      apiKey: "AIzaSyDxY8B0DBksYyCR0CVMuJjxAoRU-z6oF-A",
      authDomain: "japan-trip-2026-c5760.firebaseapp.com",
      databaseURL: "https://japan-trip-2026-c5760-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "japan-trip-2026-c5760",
      storageBucket: "japan-trip-2026-c5760.firebasestorage.app",
      messagingSenderId: "955400726204",
      appId: "1:955400726204:web:56c4d76cfe1800c42212b9"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();
    const expenseRef = db.ref("shared_expenses");

    // ---------- Hero Image ----------
    const HERO_IMAGE = "https://www.info-toyama.com/storage/special_features/339/responsive_images/U0rmlSsFfDZfqLX5S080ZdXPtjr7kmOIBCMTiwu7__1169_779.jpeg";

    // ---------- Helpers ----------
    const cx = (...args) => args.filter(Boolean).join(" ");
    const fmtInt = (n) => new Intl.NumberFormat("zh-TW").format(Math.round(n || 0));

    function loadJSON(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return fallback;
        return JSON.parse(raw);
      } catch {
        return fallback;
      }
    }
    function saveJSON(key, value) {
      try {
        localStorage.setItem(key, JSON.stringify(value));
      } catch {}
    }

    // ---------- Trip Days ----------
    const TRIP_DAYS = [
      { key: "2026-01-01", label: "1/1ï¼ˆå››ï¼‰" },
      { key: "2026-01-02", label: "1/2ï¼ˆäº”ï¼‰" },
      { key: "2026-01-03", label: "1/3ï¼ˆå…­ï¼‰" },
      { key: "2026-01-04", label: "1/4ï¼ˆæ—¥ï¼‰" },
      { key: "2026-01-05", label: "1/5ï¼ˆä¸€ï¼‰" },
    ];

    // ---------- Locations for Weather ----------
    const LOC_BY_DAY = {
      "2026-01-01": { name: "é‡‘æ¾¤", lat: 36.5613, lon: 136.6562 },
      "2026-01-02": { name: "é«˜å±±", lat: 36.1333, lon: 137.25 },
      "2026-01-03": { name: "é‡‘æ¾¤", lat: 36.5613, lon: 136.6562 },
      "2026-01-04": { name: "å¯Œå±±", lat: 36.696, lon: 137.214 },
      "2026-01-05": { name: "å°æ¾", lat: 36.3946, lon: 136.4066 },
    };

    // æ–°å¢ï¼šé€›è¡—
    const CATEGORY = {
      sight: { label: "æ™¯é»", pill: "bg-moss-100 text-moss-800 ring-1 ring-moss-200", dot: "bg-moss-500" },
      food:  { label: "ç¾é£Ÿ", pill: "bg-clay-100 text-clay-800 ring-1 ring-clay-200", dot: "bg-clay-500" },
      move:  { label: "äº¤é€š", pill: "bg-sand-100 text-sand-800 ring-1 ring-sand-200", dot: "bg-sand-500" },
      stay:  { label: "ä½å®¿", pill: "bg-slate-100 text-slate-700 ring-1 ring-slate-200", dot: "bg-slate-500" },
      shop:  { label: "é€›è¡—", pill: "bg-indigo-100 text-indigo-800 ring-1 ring-indigo-200", dot: "bg-indigo-500" },
    };

    const INITIAL_SCHEDULE = {
      "2026-01-01": [
        { id: "d1-1", time: "04:30", title: "å‡Œæ™¨åˆ°æ©Ÿå ´å ±åˆ°ï¼ˆé ä¼° 4â€“5 é»ï¼‰", category: "move", place: "æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ T2", note: "ææ—©åˆ°ã€å¡«å¯«ç·šä¸Šå…¥å¢ƒç”³è«‹ã€‚", map: "https://www.google.com/maps/search/?api=1&query=æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ç¬¬äºŒèˆªå»ˆ" },
        { id: "d1-2", time: "06:35â€“10:25", title: "âœˆï¸ é•·æ¦® BR158 æ¡ƒåœ’äºŒèˆª â†’å°æ¾æ©Ÿå ´", category: "move", place: "TPE â†’ KMQ", note: "æ©Ÿä¸Šä¼‘æ¯è£œçœ ã€‚è½åœ°å¾Œæ‰¾å·´å£«å”®ç¥¨æ©Ÿã€‚", map: "https://www.google.com/maps/search/?api=1&query=Komatsu%20Airport" },
        { id: "d1-3", time: "10:40", title: "æ­åˆ©æœ¨æ´¥å·´å£« â†’ é‡‘æ¾¤ç«™è¥¿å£ï¼ˆç´„ 40 åˆ†ï¼‰", category: "move", place: "å°æ¾æ©Ÿå ´ â†’ é‡‘æ¾¤ç«™ï¼ˆè¥¿å£ï¼‰", note: "å…ˆæ‰¾è‡ªå‹•è²©è³£æ©Ÿå–è»Šç¥¨ã€‚ã€Œå–ç¥¨ã€åˆ°å¯Œå±±é å®šç·¨è™Ÿ483322ã€åˆ°é«˜å±±é å®šç·¨è™Ÿ41160ã€å›å¯Œå±±é å®šç·¨è™Ÿ45613", map: "https://www.google.com/maps/search/?api=1&query=é‡‘æ¾¤ç«™è¥¿å£" },

        // FORUSï¼šæ”¹ç‚ºé€›è¡— + æ›´æ–°å‚™è¨»ï¼ˆä½ æä¾›çš„å…§å®¹ï¼‰
        { id: "d1-4", time: "12:00", title: "æ­¥è¡Œ 5 åˆ†é˜ â†’ é‡‘æ¾¤ FORUS å¯„è¡Œæ & é€›è¡—", category: "shop", place: "Kanazawa FORUS / é‡‘æ¾¤è»Šç«™", note:
`FORUS
nico and... 3F (ç‡Ÿæ¥­æ™‚é–“10:00 - 19:00)
Free-Spirits Kanazawa 4F (ç‡Ÿæ¥­æ™‚é–“10:00 - 19:00)
UQã€ç„¡å°ã€å¯¶å¯å¤¢ä¸­å¿ƒã€ABCã€LOFT 5F (ç‡Ÿæ¥­æ™‚é–“10:00 - 19:00)
æ˜Ÿå·´å…‹ 6F(ç‡Ÿæ¥­æ™‚é–“11:00 - 20:00)`,
          map: "https://www.google.com/maps/search/?api=1&query=Kanazawa%20Forus"
        },

        { id: "d1-5", time: "16:00â€“17:00", title: "é£¯åº— Check in", category: "stay", place: "SOKI KANAZAWA", note: "æŠŠè¡Œææ”¾å¥½ã€ç¨å¾®ä¼‘æ¯ä¸€ä¸‹ã€‚", map: "https://maps.app.goo.gl/AiNn6tNwGVsXf5JUA" },
        { id: "d1-6", time: "17:00â€“18:00", title: "mont bell è²·è²·", category: "shop", place: "é‡‘æ¾¤", note: "ç‡Ÿæ¥­æ™‚é–“ 10:00 - 20:00", map: "https://www.google.com/maps/search/?api=1&query=mont-bell%20é‡‘æ²¢" },
        { id: "d1-7", time: "18:00â€“19:00", title: "æ™šé¤ã€æ”¤è²©å°åƒ", category: "food", place: "é‡‘æ¾¤", note: "éš¨ç·£åƒå¥½åƒçš„ï½", map: "https://www.google.com/maps/search/?api=1&query=é‡‘æ²¢%20å±‹å°%20ã‚°ãƒ«ãƒ¡" },
        { id: "d1-8", time: "19:00â€“20:00", title: "ç¥ç¤¾åƒæ‹œï¼ˆå°¾å±±ç¥ç¤¾ï¼‰", category: "sight", place: "å°¾å±±ç¥ç¤¾", note: "ç‡Ÿæ¥­æ™‚é–“ 00:00 - 21:00", map: "https://www.google.com/maps/search/?api=1&query=å°¾å±±ç¥ç¤¾" },
        { id: "d1-9", time: "20:00â€“21:00", title: "ç‰‡ç”ºï¼šé—œæ±ç…® + C-pla é‡‘æ²¢ç‰‡ç”ºåº— æ‰­è›‹", category: "shop", place: "ç‰‡ç”º Katamachi", note: "C-pla ç‡Ÿæ¥­æ™‚é–“ 10:00 - 21:00", map: "https://www.google.com/maps/search/?api=1&query=C-pla%20é‡‘æ²¢ç‰‡ç”ºåº—" },
        { id: "d1-10", time: "21:00â€“22:00", title: "ä¼‘æ¯", category: "stay", place: "å›é£¯åº—", note: "æ—©é»ç¡ï¼Œéš”å¤©ç§»å‹•å¤šã€‚", map: "" },
      ],

      "2026-01-02": [
        { id: "d2-1", time: "06:00", title: "èµ·åºŠæ¢³æ´—ã€ä¾¿åˆ©å•†åº—è£œçµ¦", category: "food", place: "é‡‘æ¾¤", note: "å‡ºç™¼å‰è²·æ°´/æ—©é¤ã€‚", map: "https://www.google.com/maps/search/?api=1&query=é‡‘æ¾¤%20ä¾¿åˆ©å•†åº—" },
        { id: "d2-2", time: "06:51â€“07:14", title: "ğŸš„ æ–°å¹¹ç·š åŠ Tsurugi 60ï¼šé‡‘æ¾¤ â†’ å¯Œå±±", category: "move", place: "é‡‘æ¾¤ç«™ â†’å¯Œå±±ç«™", note: "æº–æ™‚é€²ç«™ï¼Œç•™æ„æœˆå°ã€‚", map: "https://www.google.com/maps/search/?api=1&query=Toyama%20Station" },
        { id: "d2-3", time: "07:58â€“09:28", title: "ğŸš„ ç‰¹æ€¥ é£›é©’ Hida 6ï¼ˆæŒ‡å®šå¸­ï¼‰ï¼šå¯Œå±±â†’ é«˜å±±", category: "move", place: "å¯Œå±±ç«™ â†’é«˜å±±ç«™", note: "è»Šä¸Šå¯è£œçœ /çœ‹è¡Œç¨‹ã€‚", map: "https://www.google.com/maps/search/?api=1&query=Takayama%20Station" },

        // 10:00â€“12:00ï¼ˆåˆä½µä¸€å€‹å€å¡Šï¼Œå«ä½ æ–°å¢çš„æ¸…å–®ï¼‰
        { id: "d2-4", time: "10:00â€“12:00", title: "è€è¡—é€›é€›ï¼ˆå’–å•¡/äºŒæ‰‹/ç‰©ç”¢/å’Œè“å­ï¼‰", category: "shop", place: "é«˜å±±è€è¡—", note:
`æ˜Ÿå·´å…‹ é«˜å±±å²¡æœ¬åº—ï¼ˆé™å®šæœ¨æ¼†æ¯ï¼‰(ç‡Ÿæ¥­æ™‚é–“08:00 - 21:00)
é§¿æ²³å±‹ Asumoåº— (ç‡Ÿæ¥­æ™‚é–“10:00 - 18:00)
é£›é©’ç‰©ç”¢é¤¨ (ç‡Ÿæ¥­æ™‚é–“07:00 - 22:00)
å’Œè“å­ ã²ã‚ˆã“åºµ (ç‡Ÿæ¥­æ™‚é–“10:30 - 19:00)`,
          map: "https://www.google.com/maps/search/?api=1&query=é«˜å±±%20å¤ã„ç”ºä¸¦"
        },

        { id: "d2-5", time: "12:00â€“13:00", title: "åˆé¤ï¼šè€è¡—å°åƒè§£æ±º", category: "food", place: "é«˜å±±è€è¡—", note: "ex å…­æ‹¾ç•ª / çœ‹çœ‹å’–å“©ï¼ˆå¼±å°Šï¼‰/ æˆ–çœ‹æ‹‰éºµåº—æœ‰æ²’æœ‰é–‹", map: "https://www.google.com/maps/search/?api=1&query=é«˜å±±%20é£Ÿã¹æ­©ã" },

        // 13:00â€“14:00ï¼ˆåˆä½µä¸€å€‹å€å¡Šï¼Œå«ä½ æ–°å¢çš„æ¸…å–®ï¼‰
        { id: "d2-6", time: "13:00â€“14:00", title: "å†é€›ä¸€è¼ªï¼šé…’é€ /ç”œé»/æ–‡å…·/ç…é¤…/éºµåŒ…", category: "shop", place: "é«˜å±±è€è¡—", note:
`èˆ©å‚é…’é€ åº—ï¼ˆæ‰­è›‹é…’å» ï¼‰(ç‡Ÿæ¥­æ™‚é–“08:30 - 18:00)
ã¿ã£ãµãƒãƒ¼ ãŠã‚„ã¤å ‚ é£›é¨¨é«˜å±±åº—ï¼ˆmiffyï¼‰(ç‡Ÿæ¥­æ™‚é–“09:30 - 17:00)
é«˜å±±å¸ƒä¸äº­ (ç‡Ÿæ¥­æ™‚é–“10:00 - 16:30)
Pen Shop IMAI (ç‡Ÿæ¥­æ™‚é–“10:00 - 18:00)
æ©‹æœ¬ç…é¤…å ‚ (ç‡Ÿæ¥­æ™‚é–“09:00 - 17:00)
Komaya Pan (ç‡Ÿæ¥­æ™‚é–“08:00 - 19:00)`,
          map: "https://www.google.com/maps/search/?api=1&query=èˆ©å‚é…’é€ åº—"
        },

        { id: "d2-7", time: "15:17â€“16:44", title: "ğŸš„ ç‰¹æ€¥ é£›é©’ Hida 11ï¼šé«˜å±± â†’ å¯Œå±±", category: "move", place: "é«˜å±±ç«™ â†’å¯Œå±±ç«™", note: "å›ç¨‹è£œçœ ã€‚", map: "https://www.google.com/maps/search/?api=1&query=Toyama%20Station" },
        { id: "d2-8", time: "17:10", title: "ğŸš„ æ–°å¹¹ç·šï¼ˆè‡ªç”±å¸­ï¼‰ï¼šå¯Œå±± â†’ é‡‘æ¾¤", category: "move", place: "å¯Œå±± â†’é‡‘æ¾¤", note: "ç¾å ´è²·ç¥¨ï¼›äººå¤šæ™‚ææ—©æ’éšŠã€‚", map: "https://www.google.com/maps/search/?api=1&query=é‡‘æ¾¤ç«™" },

        { id: "d2-9", time: "18:00â€“19:00", title: "æ™šé¤", category: "food", place: "é‡‘æ¾¤ï¼ˆæˆ–é«˜å±±æ²’åƒåˆ°å°±è£œï¼‰", note:
`Go Go Curry ã‚´ãƒ¼ã‚´ãƒ¼ã‚«ãƒ¬ãƒ¼ (ç‡Ÿæ¥­æ™‚é–“10:00 - 22:00)ï¼ˆå¦‚æœæ²’åœ¨é«˜å±±åƒå’–å“©çš„è©±ï¼‰
é•·è°·å·äº­ (ç‡Ÿæ¥­æ™‚é–“11:30 - 22:00)`,
          map: "https://www.google.com/maps/search/?api=1&query=é‡‘æ²¢%20ã‚´ãƒ¼ã‚´ãƒ¼ã‚«ãƒ¬ãƒ¼"
        },
        { id: "d2-10", time: "19:00â€“20:00", title: "åˆ°è™•æ™ƒæ™ƒ", category: "sight", place: "é‡‘æ¾¤", note: "æ•£æ­¥æ¶ˆåŒ–ã€çœ‹æ°£æ°›æ±ºå®šçºŒæ”¤æˆ–å›é£¯åº—ã€‚", map: "https://www.google.com/maps/search/?api=1&query=é‡‘æ²¢%20å¤œ%20æ•£æ­©" },
        { id: "d2-11", time: "20:00â€“21:00", title: "ä¼‘æ¯", category: "stay", place: "å›é£¯åº—", note: "æ•´ç†æˆ°åˆ©å“ã€å……é›»ã€‚", map: "" },
      ],

      // DAY3ï¼šæ•´å¤©æ”¹ç‚ºé‡‘æ¾¤è·¯ç·šï¼ˆä½ æä¾›çš„æ–°ç‰ˆæœ¬ï¼‰
      "2026-01-03": [
        { id: "d3-1", time: "07:00", title: "é£¯åº—æ—©é¤ï¼ˆ7é»æº–æ™‚åƒé£¯ï¼ï¼‰", category: "food", place: "SOKI KANAZAWA", note: "åƒé£½ä¸€é»ï¼Œå…¼å…­åœ’èµ°è·¯å¤šã€‚", map: "https://maps.app.goo.gl/AiNn6tNwGVsXf5JUA" },

        { id: "d3-2", time: "08:00â€“10:00", title: "å…¼å…­åœ’ & é‡‘æ¾¤åŸ", category: "sight", place: "å…¼å…­åœ’ï¼é‡‘æ¾¤åŸ", note:
`å…¼å…­åœ’ï¼ˆç‡Ÿæ¥­æ™‚é–“ 08:00 - 17:00ï¼‰å¤§äºº 320 æ—¥åœ“
é‡‘æ¾¤åŸï¼ˆç‡Ÿæ¥­æ™‚é–“ 08:00 - 17:00ï¼‰å…è²»
è±æ«“/äº”åé–“é•·å±‹/æ©‹çˆªé–€çºŒæ«“ å¤§äºº 320 æ—¥åœ“
å¯è²·ï¼šå…¼å…­åœ’ï¼‹1 é–€ç¥¨`,
          map: "https://www.google.com/maps/search/?api=1&query=å…¼å…­åœ’"
        },

        { id: "d3-3", time: "10:00â€“11:00", title: "SWAY COFFEE", category: "food", place: "é‡‘æ¾¤", note: "ç‡Ÿæ¥­æ™‚é–“ 08:30 - 18:00", map: "https://www.google.com/maps/search/?api=1&query=SWAY%20COFFEE%20é‡‘æ²¢" },

        { id: "d3-4", time: "11:00â€“12:00", title: "é‡‘æ¾¤21ä¸–ç´€ç¾è¡“é¤¨ï¼ˆæ¸¸æ³³æ± ï¼ï¼‰", category: "sight", place: "é‡‘æ¾¤", note: "ç‡Ÿæ¥­æ™‚é–“ 09:00 - 18:00", map: "https://www.google.com/maps/search/?api=1&query=21st%20Century%20Museum%20of%20Contemporary%20Art%20Kanazawa" },

        { id: "d3-5", time: "12:00â€“13:00", title: "åˆé¤", category: "food", place: "é‡‘æ¾¤", note: "çœ‹ç•¶ä¸‹äººæ½®/æƒ³åƒçš„æ±ºå®šã€‚", map: "https://www.google.com/maps/search/?api=1&query=é‡‘æ²¢%20ãƒ©ãƒ³ãƒ" },

        { id: "d3-6", time: "13:00â€“14:00", title: "Le MusÃ©e de H é‡‘æ¾¤åº—ï¼ˆè²·ä¼´æ‰‹ç¦®å°±å¥½ï¼‰", category: "food", place: "é‡‘æ¾¤", note: "ç‡Ÿæ¥­æ™‚é–“ 10:00 - 16:00ï¼ˆ15:00 æœ€å¾Œé»é¤ï¼‰", map: "https://www.google.com/maps/search/?api=1&query=Le%20Mus%C3%A9e%20de%20H%20Kanazawa" },

        { id: "d3-7", time: "14:00â€“15:00", title: "æ±èŒ¶å±‹è¡— / é‡‘æ¾¤å¸ƒä¸ & å†°æ·‡æ·‹", category: "sight", place: "æ±èŒ¶å±‹è¡—", note: "ï¼ˆç‡Ÿæ¥­æ™‚é–“ 10:00 - 16:00ï¼‰", map: "https://www.google.com/maps/search/?api=1&query=æ±èŒ¶å±‹è¡—%20é‡‘æ¾¤" },

        { id: "d3-8", time: "16:00â€“17:00", title: "Kajimart Kanazawa Mâ€™ZA Store è¶…å¸‚æ¡è³¼ â†’ å›é£¯åº—æ”¾", category: "shop", place: "é‡‘æ¾¤", note: "æ¡è³¼é›¶é£Ÿã€é£²æ–™ã€éš”å¤©è·¯ä¸Šé£Ÿç‰©ã€‚", map: "https://www.google.com/maps/search/?api=1&query=Kajimart%20Kanazawa%20Mâ€™ZA" },
      ],

      // DAY4ï¼šæ”¹æˆæ—©é¤ + é‡‘æ¾¤â†’å¯Œå±±äº¤é€šï¼ˆä½ æä¾›çš„æ–°ç‰ˆæœ¬ï¼‰
      "2026-01-04": [
        { id: "d4-1", time: "08:00â€“09:00", title: "æ—©é¤ï¼šæ±å‡ºçˆç²åº—", category: "food", place: "é‡‘æ¾¤", note: "ç‡Ÿæ¥­æ™‚é–“ 09:00 - 18:00", map: "https://www.google.com/maps/search/?api=1&query=æ±å‡ºçˆç²åº—" },

        { id: "d4-2", time: "09:00â€“10:00", title: "é‡‘æ¾¤ â†’ å¯Œå±±ï¼ˆäº¤é€šæ“‡ä¸€ï¼‰", category: "move", place: "é‡‘æ¾¤ç«™ â†’ å¯Œå±±ç«™", note:
`1) åŒ—é™¸æ–°å¹¹ç·š 2,860 å††ï¼ˆ41 åˆ†ï¼‰
2) IRçŸ³å·éµé“ 1,290 å††ï¼ˆ63 åˆ†ï¼‰`,
          map: "https://www.google.com/maps/search/?api=1&query=Toyama%20Station"
        },

        { id: "d4-3", time: "10:30â€“", title: "å¯Œå±±å¸‚å€è¡Œç¨‹ï¼ˆå½ˆæ€§å®‰æ’ï¼‰", category: "sight", place: "å¯Œå±±å¸‚å€", note: "ä¾å¤©æ°£/é«”åŠ›å¾®èª¿ï¼Œæƒ³é€›è¡—ä¹Ÿå¯ä»¥æŠŠé€™æ®µç•¶ä½œé€›è¡—æ™‚é–“ã€‚", map: "https://www.google.com/maps/search/?api=1&query=å¯Œå±±å¸‚" },
      ],

      "2026-01-05": [
        { id: "d5-1", time: "08:00", title: "æ¸…æ™¨æ•´ç†è¡Œæã€æº–å‚™å‡ºé–€", category: "stay", place: "é‡‘æ¾¤", note: "é€€æˆ¿ã€æª¢æŸ¥å……é›»å™¨/è­·ç…§ã€‚", map: "" },
        { id: "d5-2", time: "09:30", title: "é‡‘æ¾¤ â†’å°æ¾æ©Ÿå ´ï¼ˆå·´å£«ï¼‰", category: "move", place: "é‡‘æ¾¤ç«™â†’ å°æ¾æ©Ÿå ´", note: "é ç•™å€™è»Šèˆ‡æ’éšŠæ™‚é–“ã€‚", map: "https://www.google.com/maps/search/?api=1&query=Komatsu%20Airport" },
        { id: "d5-3", time: "11:45â€“14:35", title: "âœˆï¸ é•·æ¦® BR157 å°æ¾ â†’ æ¡ƒåœ’äºŒèˆª", category: "move", place: "KMQ â†’ TPE", note: "å¹³å®‰å›å®¶ï½", map: "https://www.google.com/maps/search/?api=1&query=æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ç¬¬äºŒèˆªå»ˆ" },
      ],
    };

    const INITIAL_BOOKINGS = {
      flight: {
        airline: "EVA Air é•·æ¦®èˆªç©º",
        flightNoGo: "BR158",
        flightNoBack: "BR157",
        from: "TPE æ¡ƒåœ’ T2",
        to: "KMQ å°æ¾",
        departGo: "2026-01-01 06:35",
        arriveGo: "2026-01-01 10:25",
        departBack: "2026-01-05 11:45",
        arriveBack: "2026-01-05 14:35",
      },
      hotel: {
        name: "SOKI KANAZAWA",
        map: "https://maps.app.goo.gl/AiNn6tNwGVsXf5JUA",
        addressJa: "ã€’920-0909 çŸ³å·çœŒé‡‘æ²¢å¸‚è¢‹ç”º2-1",
        addressEn: "2-1 Fukuromachi, Kanazawa-shi, Ishikawa 920-0909, Japan",
        phone: "+81-76-210-0270",
        checkin: "15:00",
        checkout: "11:00",
      },
    };

    // ---------- UI Primitives ----------
    function Hero() {
      return (
        <div className="relative mx-auto max-w-md">
          <div className="safe-t" />
          <div className="relative h-52 overflow-hidden">
            <img
              src={HERO_IMAGE}
              alt="ç«‹å±±é€£å³°"
              className="h-full w-full object-cover"
              onError={(e) => {
                e.currentTarget.style.display = "none";
              }}
            />
            <div className="absolute inset-0 bg-gradient-to-t from-sand-50 via-black/10 to-black/25" />
            <div className="absolute left-4 bottom-4 right-4">
              <div className="inline-flex items-center gap-2 rounded-full bg-white/75 px-3 py-1 text-xs font-semibold text-sand-800 ring-1 ring-white/70 backdrop-blur">
                ğŸ”ï¸ ç«‹å±±é€£å³°
              </div>
              <div className="mt-2 text-2xl font-semibold tracking-tight text-white drop-shadow">
                2026æ—¥æœ¬åŒ—é™¸æ—…è¡Œ
              </div>
            </div>
          </div>
        </div>
      );
    }

    function TopBar({ subtitle }) {
      return (
        <div className="sticky top-0 z-30 bg-sand-50/88 backdrop-blur-md">
          <div className="mx-auto max-w-md px-4 pt-3 pb-3">
            <div className="flex items-end justify-between gap-3">
              <div>
                <div className="text-[13px] text-sand-600">{subtitle}</div>
                <div className="text-xl font-semibold tracking-tight">2026æ—¥æœ¬åŒ—é™¸æ—…è¡Œ</div>
              </div>
              <div className="flex items-center gap-2">
                <div className="rounded-full bg-white shadow-soft px-3 py-1 text-[12px] text-sand-700 ring-1 ring-sand-100">
                  é‡‘æ¾¤ãƒ»å¯Œå±±ãƒ»é«˜å±±
                </div>
              </div>
            </div>
          </div>
          <div className="h-px bg-sand-100" />
        </div>
      );
    }

    function Card({ children, className }) {
      return (
        <div className={cx("rounded-xl2 bg-white shadow-soft ring-1 ring-sand-100", className)}>
          {children}
        </div>
      );
    }

    function Modal({ open, onClose, title, children }) {
      const ref = useRef(null);

      useEffect(() => {
        if (!open) return;
        const onKey = (e) => e.key === "Escape" && onClose();
        window.addEventListener("keydown", onKey);
        return () => window.removeEventListener("keydown", onKey);
      }, [open, onClose]);

      useEffect(() => {
        if (open) setTimeout(() => ref.current?.focus(), 0);
      }, [open]);

      if (!open) return null;

      return (
        <div className="fixed inset-0 z-50">
          <div className="absolute inset-0 bg-black/35" onClick={onClose} />
          <div className="absolute inset-x-0 bottom-0 mx-auto max-w-md px-3 pb-3 safe-b">
            <div
              className="grain relative rounded-2xl bg-sand-50 shadow-soft2 ring-1 ring-sand-200 outline-none"
              tabIndex={-1}
              ref={ref}
            >
              <div className="flex items-center justify-between px-4 pt-4">
                <div className="text-base font-semibold">{title}</div>
                <button
                  onClick={onClose}
                  className="rounded-full bg-white/80 px-3 py-1 text-sm ring-1 ring-sand-200 hover:bg-white"
                >
                  é—œé–‰
                </button>
              </div>
              <div className="px-4 pb-4 pt-3">{children}</div>
            </div>
          </div>
        </div>
      );
    }

    function TabBar({ tab, setTab }) {
      const items = [
        { key: "schedule", label: "è¡Œç¨‹", icon: "ğŸ—“ï¸" },
        { key: "bookings", label: "é è¨‚", icon: "ğŸ«" },
        { key: "expense", label: "è¨˜å¸³", icon: "ğŸ§¾" },
      ];
      return (
        <div className="safe-b fixed inset-x-0 bottom-0 z-40 bg-sand-50/90 backdrop-blur-md">
          <div className="mx-auto max-w-md px-4 pb-2 pt-2">
            <div className="grid grid-cols-3 gap-2 rounded-2xl bg-white shadow-soft ring-1 ring-sand-100 p-2">
              {items.map((it) => {
                const active = tab === it.key;
                return (
                  <button
                    key={it.key}
                    onClick={() => setTab(it.key)}
                    className={cx(
                      "rounded-2xl px-3 py-2 text-sm font-medium transition",
                      active ? "bg-moss-600 text-white shadow-soft" : "bg-sand-50 text-sand-800 hover:bg-sand-100"
                    )}
                  >
                    <div className="flex items-center justify-center gap-2">
                      <span className={cx("text-base", active ? "" : "opacity-90")}>{it.icon}</span>
                      <span>{it.label}</span>
                    </div>
                  </button>
                );
              })}
            </div>
          </div>
        </div>
      );
    }

    // ---------- Weather ----------
    function codeToText(code) {
      const m = {
        0: { icon: "â˜€ï¸", label: "æ™´" },
        1: { icon: "ğŸŒ¤ï¸", label: "å¤§è‡´æ™´" },
        2: { icon: "â›…ï¸", label: "å±€éƒ¨å¤šé›²" },
        3: { icon: "â˜ï¸", label: "å¤šé›²" },
        45: { icon: "ğŸŒ«ï¸", label: "éœ§" },
        48: { icon: "ğŸŒ«ï¸", label: "éœ§ï¼ˆéœœï¼‰" },
        51: { icon: "ğŸŒ¦ï¸", label: "æ¯›æ¯›é›¨" },
        53: { icon: "ğŸŒ¦ï¸", label: "æ¯›æ¯›é›¨" },
        55: { icon: "ğŸŒ§ï¸", label: "æ¯›æ¯›é›¨ï¼ˆå¼·ï¼‰" },
        61: { icon: "ğŸŒ§ï¸", label: "å°é›¨" },
        63: { icon: "ğŸŒ§ï¸", label: "ä¸­é›¨" },
        65: { icon: "ğŸŒ§ï¸", label: "å¤§é›¨" },
        71: { icon: "ğŸŒ¨ï¸", label: "å°é›ª" },
        73: { icon: "ğŸŒ¨ï¸", label: "ä¸­é›ª" },
        75: { icon: "â„ï¸", label: "å¤§é›ª" },
        80: { icon: "ğŸŒ¦ï¸", label: "é™£é›¨" },
        81: { icon: "ğŸŒ§ï¸", label: "é™£é›¨ï¼ˆå¼·ï¼‰" },
        82: { icon: "â›ˆï¸", label: "é›·é›¨" },
        95: { icon: "â›ˆï¸", label: "é›·é›¨" },
        96: { icon: "â›ˆï¸", label: "é›·é›¨ï¼ˆå†°é›¹ï¼‰" },
        99: { icon: "â›ˆï¸", label: "é›·é›¨ï¼ˆå†°é›¹ï¼‰" },
      };
      return m[code] || { icon: "ğŸŒ¤ï¸", label: "å¤©æ°£" };
    }

    function WeatherCard({ dayKey }) {
      const [state, setState] = useState({ status: "idle", data: null, err: "" });
      const cacheRef = useRef(new Map());

      useEffect(() => {
        const loc = LOC_BY_DAY[dayKey] || LOC_BY_DAY["2026-01-01"];
        const cacheKey = `${dayKey}@${loc.lat},${loc.lon}`;
        const cached = cacheRef.current.get(cacheKey);
        if (cached) {
          setState({ status: "ok", data: cached, err: "" });
          return;
        }

        let aborted = false;
        (async () => {
          try {
            setState({ status: "loading", data: null, err: "" });
            const url =
              "https://api.open-meteo.com/v1/forecast" +
              `?latitude=${encodeURIComponent(loc.lat)}` +
              `&longitude=${encodeURIComponent(loc.lon)}` +
              `&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max` +
              `&timezone=${encodeURIComponent("Asia/Tokyo")}` +
              `&start_date=${encodeURIComponent(dayKey)}` +
              `&end_date=${encodeURIComponent(dayKey)}`;

            const res = await fetch(url);
            if (!res.ok) throw new Error(`Weather API error: ${res.status}`);
            const json = await res.json();

            const d = {
              city: loc.name,
              date: json?.daily?.time?.[0] || dayKey,
              code: json?.daily?.weathercode?.[0],
              hi: json?.daily?.temperature_2m_max?.[0],
              lo: json?.daily?.temperature_2m_min?.[0],
              pop: json?.daily?.precipitation_probability_max?.[0],
            };

            cacheRef.current.set(cacheKey, d);
            if (!aborted) setState({ status: "ok", data: d, err: "" });
          } catch (e) {
            if (!aborted) setState({ status: "error", data: null, err: e?.message || "Unknown error" });
          }
        })();

        return () => { aborted = true; };
      }, [dayKey]);

      return (
        <Card className="p-4">
          <div className="flex items-center justify-between gap-4">
            <div>
              <div className="text-sm text-sand-600">å¤©æ°£</div>
              {state.status === "loading" && (
                <div className="mt-2">
                  <div className="h-4 w-36 rounded bg-sand-100" />
                  <div className="mt-2 h-3 w-52 rounded bg-sand-100" />
                </div>
              )}
              {state.status === "error" && (
                <div className="mt-2 text-sm text-clay-700">è®€å–å¤©æ°£å¤±æ•—ï¼ˆ{state.err}ï¼‰</div>
              )}
              {state.status === "ok" && state.data && (
                <>
                  <div className="mt-1 flex items-baseline gap-2">
                    <div className="text-2xl">{codeToText(state.data.code).icon}</div>
                    <div className="text-lg font-semibold">
                      {codeToText(state.data.code).label}
                      <span className="ml-2 text-sm font-medium text-sand-600">Â· {state.data.city}</span>
                    </div>
                  </div>
                  <div className="mt-1 text-sm text-sand-700">
                    {Math.round(state.data.lo)}Â°C â€“ {Math.round(state.data.hi)}Â°C
                    <span className="mx-2 text-sand-300">â€¢</span>
                    é™é›¨ {state.data.pop ?? "â€”"}%
                  </div>
                </>
              )}
            </div>
            <div className="text-right">
              <div className="text-xs text-sand-500">å¿«é€Ÿæç¤º</div>
              <div className="mt-1 text-sm font-medium text-sand-800">
                {state.status === "ok" && state.data?.pop >= 50 ? "å¸¶å‚˜/é˜²æ°´é‹" : "åˆ†å±¤ä¿æš–"}
              </div>
            </div>
          </div>
        </Card>
      );
    }

    // ---------- Schedule ----------
    function DateStrip({ selected, onSelect }) {
      return (
        <div className="no-scrollbar -mx-4 overflow-x-auto px-4">
          <div className="flex gap-2 py-2">
            {TRIP_DAYS.map((d) => {
              const active = d.key === selected;
              return (
                <button
                  key={d.key}
                  onClick={() => onSelect(d.key)}
                  className={cx(
                    "shrink-0 rounded-2xl px-4 py-2 text-sm font-medium ring-1 transition",
                    active ? "bg-moss-600 text-white ring-moss-600 shadow-soft" : "bg-white text-sand-800 ring-sand-100 hover:bg-sand-50"
                  )}
                >
                  {d.label}
                </button>
              );
            })}
          </div>
        </div>
      );
    }

    function TimelineItem({ item, onClick }) {
      const meta = CATEGORY[item.category] ?? CATEGORY.sight;
      return (
        <button
          onClick={onClick}
          className="w-full text-left rounded-2xl bg-white ring-1 ring-sand-100 shadow-soft px-4 py-3 hover:bg-sand-50 transition"
        >
          <div className="flex items-start gap-3">
            <div className="mt-1 flex flex-col items-center">
              <div className={cx("h-3 w-3 rounded-full", meta.dot)} />
              <div className="mt-2 h-10 w-px bg-sand-100" />
            </div>
            <div className="min-w-0 flex-1">
              <div className="flex items-center justify-between gap-3">
                <div className="text-sm font-semibold text-sand-900">{item.time}</div>
                <span className={cx("shrink-0 rounded-full px-2 py-1 text-[12px] font-semibold", meta.pill)}>
                  {meta.label}
                </span>
              </div>
              <div className="mt-1 text-[15px] font-semibold leading-snug">{item.title}</div>
              <div className="mt-1 text-sm text-sand-600 truncate">{item.place}</div>
            </div>
            <div className="mt-1 shrink-0 text-sand-400">â€º</div>
          </div>
        </button>
      );
    }

    function ScheduleTab({ scheduleByDay, updateNote }) {
      const [dayKey, setDayKey] = useState(TRIP_DAYS[0].key);
      const [selectedItem, setSelectedItem] = useState(null);
      const items = scheduleByDay[dayKey] ?? [];

      return (
        <div className="mx-auto max-w-md px-4 pb-28 pt-4">
          <DateStrip selected={dayKey} onSelect={setDayKey} />
          <div className="mt-2">
            <WeatherCard dayKey={dayKey} />
          </div>
          <div className="mt-4 flex items-center justify-between">
            <div className="text-base font-semibold">{TRIP_DAYS.find((d) => d.key === dayKey)?.label}</div>
            <div className="text-xs text-sand-500">{items.length} å€‹é …ç›®</div>
          </div>
          <div className="mt-3 space-y-3">
            {items.map((it) => (
              <TimelineItem key={it.id} item={it} onClick={() => setSelectedItem(it)} />
            ))}
          </div>
          <Modal open={!!selectedItem} onClose={() => setSelectedItem(null)} title="è¡Œç¨‹è©³æƒ…">
            {selectedItem && (
              <div className="space-y-3">
                <div className="flex items-start justify-between gap-3">
                  <div>
                    <div className="text-sm text-sand-600">{selectedItem.time}</div>
                    <div className="mt-1 text-lg font-semibold leading-snug">{selectedItem.title}</div>
                    <div className="mt-1 text-sm text-sand-700">{selectedItem.place}</div>
                  </div>
                  <span className={cx("shrink-0 rounded-full px-3 py-1 text-[12px] font-semibold", (CATEGORY[selectedItem.category] ?? CATEGORY.sight).pill)}>
                    {(CATEGORY[selectedItem.category] ?? CATEGORY.sight).label}
                  </span>
                </div>
                <Card className="p-3">
                  <div className="text-xs text-sand-500">å‚™è¨»</div>
                  <div className="mt-2 w-full rounded-2xl bg-white px-3 py-3 text-sm leading-relaxed ring-1 ring-sand-100 text-sand-800 whitespace-pre-line">
                    {selectedItem.note || "æš«ç„¡å‚™è¨»"}
                  </div>
                </Card>
                <div className="flex gap-2">
                  <a href={selectedItem.map || "#"} target="_blank" rel="noreferrer" className={cx("flex-1 rounded-2xl px-4 py-3 text-center text-sm font-semibold shadow-soft ring-1 transition", selectedItem.map ? "bg-moss-600 text-white ring-moss-600 hover:bg-moss-700" : "bg-sand-100 text-sand-400 ring-sand-200 pointer-events-none")}>
                    æ‰“é–‹åœ°åœ–
                  </a>
                </div>
              </div>
            )}
          </Modal>
        </div>
      );
    }

    // ---------- Bookings ----------
    function BoardingPass({ flight, direction }) {
      const isGo = direction === "go";
      const from = isGo ? flight.from : flight.to;
      const to = isGo ? flight.to : flight.from;
      const no = isGo ? flight.flightNoGo : flight.flightNoBack;
      const depart = isGo ? flight.departGo : flight.departBack;
      const arrive = isGo ? flight.arriveGo : flight.arriveBack;
      return (
        <div className="relative overflow-hidden rounded-2xl bg-gradient-to-br from-moss-700 to-moss-600 text-white shadow-soft">
          <div className="grain absolute inset-0 opacity-80" />
          <div className="relative p-4">
            <div className="flex items-start justify-between">
              <div>
                <div className="text-xs text-white/80">{flight.airline}</div>
                <div className="mt-1 text-lg font-semibold tracking-tight">Boarding Pass</div>
              </div>
              <div className="rounded-full bg-white/15 px-3 py-1 text-xs font-semibold ring-1 ring-white/25">
                {isGo ? "å»ç¨‹" : "å›ç¨‹"} Â· {no}
              </div>
            </div>
            <div className="mt-4 grid grid-cols-3 items-center gap-3">
              <div>
                <div className="text-xs text-white/70">From</div>
                <div className="mt-1 text-base font-semibold">{from.split(" ")[0]}</div>
                <div className="text-xs text-white/70">{from.replace(from.split(" ")[0], "").trim()}</div>
              </div>
              <div className="text-center">
                <div className="text-2xl">âœˆï¸</div>
                <div className="mt-1 text-xs text-white/70">Non-stop</div>
              </div>
              <div className="text-right">
                <div className="text-xs text-white/70">To</div>
                <div className="mt-1 text-base font-semibold">{to.split(" ")[0]}</div>
                <div className="text-xs text-white/70">{to.replace(to.split(" ")[0], "").trim()}</div>
              </div>
            </div>
            <div className="mt-4 grid grid-cols-2 gap-3">
              <div className="rounded-2xl bg-white/12 p-3 ring-1 ring-white/20">
                <div className="text-xs text-white/70">Depart</div>
                <div className="mt-1 text-sm font-semibold">{depart}</div>
              </div>
              <div className="rounded-2xl bg-white/12 p-3 ring-1 ring-white/20">
                <div className="text-xs text-white/70">Arrive</div>
                <div className="mt-1 text-sm font-semibold">{arrive}</div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function HotelCardLite({ hotel }) {
      return (
        <Card className="p-4 space-y-3">
          <div className="flex items-start justify-between gap-3">
            <div>
              <div className="text-sm text-sand-600">ä½å®¿</div>
              <div className="mt-1 text-base font-semibold">{hotel.name}</div>
            </div>
            <div className="rounded-2xl bg-sand-50 px-3 py-2 ring-1 ring-sand-100 text-right">
              <div className="text-[11px] text-sand-500">Check-in / out</div>
              <div className="mt-0.5 text-sm font-semibold">{hotel.checkin} / {hotel.checkout}</div>
            </div>
          </div>
          <div className="rounded-2xl bg-white p-3 ring-1 ring-sand-100">
            <div className="text-xs text-sand-500">ä½æ‰€ï¼ˆæ—¥æœ¬èªï¼‰</div>
            <div className="mt-1 text-sm text-sand-800">{hotel.addressJa}</div>
          </div>
          <div className="rounded-2xl bg-white p-3 ring-1 ring-sand-100">
            <div className="text-xs text-sand-500">Address (English)</div>
            <div className="mt-1 text-sm text-sand-800">{hotel.addressEn}</div>
          </div>
          <div className="rounded-2xl bg-white p-3 ring-1 ring-sand-100">
            <div className="text-xs text-sand-500">é›»è©± / Phone</div>
            <div className="mt-1 text-sm font-semibold text-sand-800">{hotel.phone}</div>
          </div>
          <a href={hotel.map} target="_blank" rel="noreferrer" className="block w-full rounded-2xl bg-moss-600 px-4 py-3 text-center text-sm font-semibold text-white shadow-soft hover:bg-moss-700">
            æ‰“é–‹åœ°åœ–
          </a>
        </Card>
      );
    }

    function BookingsTab() {
      const [bookings] = useState(INITIAL_BOOKINGS);
      return (
        <div className="mx-auto max-w-md px-4 pb-28 pt-4 space-y-4">
          <div className="flex items-center justify-between">
            <div>
              <div className="text-sm text-sand-600">æ©Ÿç¥¨</div>
              <div className="text-base font-semibold">ç™»æ©Ÿè­‰</div>
            </div>
            <div className="text-xs text-sand-500">BR158 / BR157</div>
          </div>
          <BoardingPass flight={bookings.flight} direction="go" />
          <BoardingPass flight={bookings.flight} direction="back" />
          <HotelCardLite hotel={bookings.hotel} />
        </div>
      );
    }

    // ---------- Expense Tab ----------
    const PEOPLE = ["æ²ˆ", "ç‘„", "YO"];

    function computeSettlement(entries) {
      const debts = Object.fromEntries(PEOPLE.map((from) => [from, Object.fromEntries(PEOPLE.map((to) => [to, 0]))]));
      for (const e of entries) {
        const payer = e.payer;
        for (const p of PEOPLE) {
          if (p === payer) continue;
          debts[p][payer] += Number(e.allocations?.[p] || 0);
        }
      }
      const net = Object.fromEntries(PEOPLE.map((from) => [from, Object.fromEntries(PEOPLE.map((to) => [to, 0]))]));
      for (let i = 0; i < PEOPLE.length; i++) {
        for (let j = i + 1; j < PEOPLE.length; j++) {
          const a = PEOPLE[i], b = PEOPLE[j];
          const diff = debts[a][b] - debts[b][a];
          if (diff > 0) net[a][b] = diff;
          else if (diff < 0) net[b][a] = -diff;
        }
      }
      const incoming = Object.fromEntries(PEOPLE.map((to) => [to, Object.fromEntries(PEOPLE.map((from) => [from, 0]))]));
      for (const from of PEOPLE) {
        for (const to of PEOPLE) incoming[to][from] = net[from][to];
      }
      const transfers = [];
      for (const from of PEOPLE) {
        for (const to of PEOPLE) {
          const amount = net[from][to];
          if (from !== to && amount > 0) transfers.push({ from, to, amount });
        }
      }
      return { transfers, incoming };
    }

    function ExpenseTab() {
      const [entries, setEntries] = useState([]);
      const [form, setForm] = useState({ dateKey: TRIP_DAYS[0].key, title: "", payer: "æ²ˆ", total: "", allocations: { æ²ˆ: "", ç‘„: "", YO: "" } });

      useEffect(() => {
        expenseRef.on('value', (snapshot) => {
          setEntries(snapshot.val() || []);
        });
        return () => expenseRef.off();
      }, []);

      const totalsByPayer = useMemo(() => {
        const m = Object.fromEntries(PEOPLE.map((p) => [p, 0]));
        for (const e of entries) m[e.payer] += Number(e.total || 0);
        return m;
      }, [entries]);

      const settlement = useMemo(() => computeSettlement(entries), [entries]);
      const dashboard = useMemo(() => {
        const values = PEOPLE.map((p) => totalsByPayer[p] || 0);
        const max = Math.max(1, ...values);
        const sum = values.reduce((a, b) => a + b, 0);
        return { values, max, sum };
      }, [totalsByPayer]);

      const grouped = useMemo(() => {
        const m = new Map();
        for (const e of entries) {
          const k = e.dateKey;
          if (!m.has(k)) m.set(k, []);
          m.get(k).push(e);
        }
        return m;
      }, [entries]);

      const formNums = useMemo(() => {
        const total = Number(form.total || 0);
        let allocSum = 0;
        for (const p of PEOPLE) allocSum += Number(form.allocations[p] || 0);
        return { total, allocSum, remaining: total - allocSum };
      }, [form]);

      const setAlloc = (name, value) => {
        setForm((f) => ({ ...f, allocations: { ...f.allocations, [name]: value.replace(/[^\d]/g, "") } }));
      };

      const splitEven = () => {
        const total = Number(form.total || 0);
        if (!total || total <= 0) return alert("è«‹å…ˆè¼¸å…¥ç¸½é‡‘é¡ï¼ˆ> 0ï¼‰");

        const base = Math.floor(total / PEOPLE.length);
        const rem = total - base * PEOPLE.length;

        const payer = form.payer;
        const others = PEOPLE.filter((p) => p !== payer);

        const alloc = Object.fromEntries(PEOPLE.map((p) => [p, base]));

        if (rem > 0) {
          const shuffledOthers = [...others].sort(() => Math.random() - 0.5);
          for (let k = 0; k < rem; k++) {
            alloc[shuffledOthers[k]] += 1;
          }
        }

        setForm({
          ...form,
          allocations: Object.fromEntries(PEOPLE.map((p) => [p, String(alloc[p])]))
        });
      };

      const addEntry = () => {
        const total = Number(form.total);
        if (!total || total <= 0) return alert("è«‹è¼¸å…¥ç¸½é‡‘é¡ï¼ˆ> 0ï¼‰");
        if (!form.title.trim()) return alert("è«‹è¼¸å…¥é …ç›®åç¨±");
        if (formNums.allocSum !== total) return alert(`åˆ†é…åŠ ç¸½ï¼š${formNums.allocSum}ï¼Œç¸½é‡‘é¡ï¼š${total}`);
        const id = "e" + Math.random().toString(16).slice(2);
        const newEntry = { id, dateKey: form.dateKey, title: form.title.trim(), payer: form.payer, total, allocations: Object.fromEntries(PEOPLE.map((p) => [p, Number(form.allocations[p] || 0)])) };
        expenseRef.set([...entries, newEntry]);
        setForm((f) => ({ ...f, title: "", total: "", allocations: { æ²ˆ: "", ç‘„: "", YO: "" } }));
      };

      const removeEntry = (id) => expenseRef.set(entries.filter((e) => e.id !== id));

      const lineForPayer = (to) => {
        const parts = PEOPLE.filter((from) => from !== to).map((from) => `${from}è¦çµ¦${to} Â¥${fmtInt(settlement.incoming?.[to]?.[from] || 0)}`);
        return parts.join("ã€");
      };

      return (
        <div className="mx-auto max-w-md px-4 pb-28 pt-4 space-y-4">
          <Card className="p-4">
            <div className="flex items-start justify-between gap-3">
              <div>
                <div className="text-sm text-sand-600">ä»£å¢Šç¸½è¦½è¡¨</div>
                <div className="mt-1 text-lg font-semibold">ç›®å‰ç´¯ç©ä»£å¢Šï¼ˆæ—¥å¹£ï¼‰</div>
              </div>
              <div className="rounded-2xl bg-sand-50 px-3 py-2 ring-1 ring-sand-100">
                <div className="text-[11px] text-sand-500">ç¸½ä»£å¢Š</div>
                <div className="mt-0.5 text-sm font-semibold">Â¥ {fmtInt(dashboard.sum)}</div>
              </div>
            </div>
            <div className="mt-4 space-y-4">
              {PEOPLE.map((name) => {
                const value = totalsByPayer[name] || 0;
                const pct = Math.round((value / dashboard.max) * 100);
                return (
                  <div key={name}>
                    <div className="flex items-center justify-between">
                      <div className="text-sm font-semibold">{name}</div>
                      <div className="text-sm font-semibold">Â¥ {fmtInt(value)}</div>
                    </div>
                    <div className="mt-2 h-3 rounded-full bg-sand-100 ring-1 ring-sand-200 overflow-hidden">
                      <div className="h-full rounded-full bg-moss-600" style={{ width: pct + "%" }} />
                    </div>
                    <div className="mt-2 text-xs text-sand-700 leading-relaxed">{lineForPayer(name)}</div>
                  </div>
                );
              })}
            </div>
            <div className="mt-4 rounded-2xl bg-white p-3 ring-1 ring-sand-100">
              <div className="text-xs text-sand-500">çµç®—å°å¡</div>
              <div className="mt-1 text-sm text-sand-800 leading-relaxed">
                {settlement.transfers.length === 0 ? (
                  <span className="font-semibold">ç›®å‰å‰›å¥½æ‰“å¹³ï¼Œä¸ç”¨äº’è½‰ã€‚</span>
                ) : (
                  <div className="space-y-1">
                    {settlement.transfers.map((t, idx) => (
                      <div key={idx}><span className="font-semibold">{t.from}</span> â†’ <span className="font-semibold">{t.to}</span>ï¼šÂ¥ {fmtInt(t.amount)}</div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          </Card>

          <Card className="p-4">
            <div className="flex items-center justify-between">
              <div>
                <div className="text-sm text-sand-600">æ–°å¢è¨˜å¸³</div>
                <div className="text-base font-semibold">è‡ªè¨‚åˆ†é…ï¼ˆä¸ä¸€å®šå¹³å‡ï¼‰</div>
              </div>
              <div className="text-xs text-sand-500">Â¥ JPY</div>
            </div>

            <div className="mt-3 grid grid-cols-2 gap-3">
              <div className="col-span-2">
                <label className="text-xs text-sand-500">æ—¥æœŸ</label>
                <select value={form.dateKey} onChange={(e) => setForm((f) => ({ ...f, dateKey: e.target.value }))} className="mt-1 w-full rounded-2xl bg-sand-50 px-3 py-3 text-sm ring-1 ring-sand-100">
                  {TRIP_DAYS.map((d) => <option key={d.key} value={d.key}>{d.label}</option>)}
                </select>
              </div>

              <div className="col-span-2">
                <label className="text-xs text-sand-500">é …ç›®</label>
                <input value={form.title} onChange={(e) => setForm((f) => ({ ...f, title: e.target.value }))} placeholder="ä¾‹å¦‚ï¼šåˆé¤ã€è»Šç¥¨ã€ç„¡å°ã€é–€ç¥¨â€¦" className="mt-1 w-full rounded-2xl bg-sand-50 px-3 py-3 text-sm ring-1 ring-sand-100" />
              </div>

              <div>
                <label className="text-xs text-sand-500">ä»˜æ¬¾äºº</label>
                <select value={form.payer} onChange={(e) => setForm((f) => ({ ...f, payer: e.target.value }))} className="mt-1 w-full rounded-2xl bg-sand-50 px-3 py-3 text-sm ring-1 ring-sand-100">
                  {PEOPLE.map((p) => <option key={p} value={p}>{p}</option>)}
                </select>
              </div>

              <div>
                <label className="text-xs text-sand-500">ç¸½é‡‘é¡ï¼ˆÂ¥ï¼‰</label>
                <input value={form.total} onChange={(e) => setForm((f) => ({ ...f, total: e.target.value.replace(/[^\d]/g, "") }))} inputMode="numeric" placeholder="æ•¸å­—" className="mt-1 w-full rounded-2xl bg-sand-50 px-3 py-3 text-sm ring-1 ring-sand-100" />
              </div>

              <div className="col-span-2">
                <div className="flex items-center justify-between">
                  <label className="text-xs text-sand-500">åˆ†é…</label>
                  <div className={cx("text-xs", formNums.remaining === 0 ? "text-moss-700" : "text-clay-700")}>å‰©é¤˜ï¼šÂ¥ {fmtInt(formNums.remaining)}</div>
                </div>
                <div className="mt-2 space-y-2">
                  {PEOPLE.map((p) => (
                    <div key={p} className="flex items-center justify-between gap-2 rounded-2xl bg-white px-3 py-3 ring-1 ring-sand-100">
                      <div className="text-sm font-semibold">{p}</div>
                      <div className="flex items-center gap-2">
                        <div className="text-xs text-sand-500">Â¥</div>
                        <input value={form.allocations[p]} onChange={(e) => setAlloc(p, e.target.value)} inputMode="numeric" placeholder="0" className="w-28 rounded-xl bg-sand-50 px-3 py-2 text-sm text-right ring-1 ring-sand-100" />
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              <div className="mt-3 grid grid-cols-2 gap-2 col-span-2">
                <button onClick={splitEven} className="w-full rounded-2xl bg-white px-4 py-3 text-sm font-semibold shadow-soft ring-1 ring-sand-100 hover:bg-sand-50">ä¸€éµå¹³åˆ†</button>
                <button onClick={addEntry} className="w-full rounded-2xl bg-moss-600 px-4 py-3 text-sm font-semibold text-white shadow-soft hover:bg-moss-700">æ–°å¢åˆ°åˆ—è¡¨</button>
              </div>
            </div>
          </Card>

          <div className="flex items-center justify-between">
            <div>
              <div className="text-sm text-sand-600">æ˜ç´°</div>
              <div className="text-base font-semibold">æ¯æ—¥æ”¯å‡º</div>
            </div>
            <div className="text-xs text-sand-500">{entries.length} ç­†</div>
          </div>

          {[...grouped.keys()].sort().map((dayKey) => {
            const day = TRIP_DAYS.find((d) => d.key === dayKey)?.label ?? dayKey;
            const arr = grouped.get(dayKey);
            const dayTotal = arr.reduce((sum, e) => sum + Number(e.total || 0), 0);
            return (
              <Card key={dayKey} className="p-4">
                <div className="flex items-center justify-between">
                  <div className="text-sm font-semibold">{day}</div>
                  <div className="text-xs text-sand-600">å°è¨ˆ Â¥ {fmtInt(dayTotal)}</div>
                </div>
                <div className="mt-3 space-y-2">
                  {arr.map((e) => (
                    <div key={e.id} className="rounded-2xl bg-sand-50 ring-1 ring-sand-100 px-3 py-3">
                      <div className="flex items-start justify-between gap-3">
                        <div className="min-w-0">
                          <div className="text-sm font-semibold truncate">{e.title}</div>
                          <div className="mt-1 text-xs text-sand-600">ä»˜æ¬¾äººï¼š<span className="font-semibold">{e.payer}</span></div>
                          <div className="mt-2 grid grid-cols-3 gap-2">
                            {PEOPLE.map((p) => (
                              <div key={p} className="rounded-xl bg-white px-2 py-2 ring-1 ring-sand-100">
                                <div className="text-[11px] text-sand-500">{p}</div>
                                <div className="mt-0.5 text-sm font-semibold">Â¥ {fmtInt(e.allocations?.[p] || 0)}</div>
                              </div>
                            ))}
                          </div>
                        </div>
                        <div className="shrink-0 text-right">
                          <div className="text-sm font-semibold">Â¥ {fmtInt(e.total)}</div>
                          <button onClick={() => removeEntry(e.id)} className="mt-2 rounded-full bg-white px-3 py-1 text-xs font-semibold ring-1 ring-sand-100 hover:bg-sand-100">åˆªé™¤</button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </Card>
            );
          })}
        </div>
      );
    }

    // ---------- App Shell ----------
    function App() {
      const savedNotes = useMemo(() => loadJSON("trip_notes_map_v1", {}), []);
      const [scheduleByDay, setScheduleByDay] = useState(() => {
        const cloned = JSON.parse(JSON.stringify(INITIAL_SCHEDULE));
        for (const dayKey of Object.keys(cloned)) {
          for (const item of cloned[dayKey]) {
            const key = `${dayKey}::${item.id}`;
            if (savedNotes[key] != null) item.note = savedNotes[key];
          }
        }
        return cloned;
      });

      const updateNote = (dayKey, itemId, note) => {
        setScheduleByDay((prev) => {
          const next = JSON.parse(JSON.stringify(prev));
          const arr = next[dayKey] || [];
          const idx = arr.findIndex((x) => x.id === itemId);
          if (idx >= 0) arr[idx].note = note;
          return next;
        });
        const key = `${dayKey}::${itemId}`;
        const nextNotes = { ...loadJSON("trip_notes_map_v1", {}), [key]: note };
        saveJSON("trip_notes_map_v1", nextNotes);
      };

      const [tab, setTab] = useState("schedule");
      const subtitle = useMemo(() => {
        if (tab === "schedule") return "è¡Œç¨‹";
        if (tab === "bookings") return "é è¨‚";
        return "è¨˜å¸³";
      }, [tab]);

      return (
        <div className="min-h-screen">
          <Hero />
          <TopBar subtitle={subtitle} />
          {tab === "schedule" && <ScheduleTab scheduleByDay={scheduleByDay} updateNote={updateNote} />}
          {tab === "bookings" && <BookingsTab />}
          {tab === "expense" && <ExpenseTab />}
          <TabBar tab={tab} setTab={setTab} />
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
